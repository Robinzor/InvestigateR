"""
MalwareBazaar normalizer - standardizes output format
"""
import logging
from typing import Dict, Any, Optional

logger = logging.getLogger(__name__)


def normalize_malwarebazaar_result(raw_result: Optional[Dict[str, Any]]) -> Dict[str, Any]:
    """
    Normalize MalwareBazaar API response into a standardized format.
    
    Args:
        raw_result: Raw API response from query_malwarebazaar_async
        
    Returns:
        Normalized dictionary with consistent structure
    """
    if not raw_result:
        return {
            "malwarebazaar": {
                "error": "No data received from MalwareBazaar"
            }
        }
    
    # Check for error in raw_result
    if "error" in raw_result:
        return {
            "malwarebazaar": {
                "error": raw_result["error"],
                "hash": raw_result.get("observable", "Unknown")
            }
        }
    
    if "raw_data" not in raw_result:
        return {
            "malwarebazaar": {
                "error": "Invalid response format from MalwareBazaar"
            }
        }
    
    data = raw_result["raw_data"]
    hash_value = raw_result.get("observable", "Unknown")
    found = raw_result.get("found", False)
    
    # Check if hash was not found
    if not found or data.get("query_status") == "hash_not_found":
        return {
            "malwarebazaar": {
                "found": False,
                "status": "Hash not found in MalwareBazaar database",
                "hash": hash_value
            }
        }
    
    # Hash was found - extract relevant information
    sha256_hash = data.get("sha256_hash", hash_value)
    md5_hash = data.get("md5_hash", "Unknown")
    sha1_hash = data.get("sha1_hash", "Unknown")
    file_name = data.get("file_name", "Unknown")
    file_type = data.get("file_type", "Unknown")
    file_size = data.get("file_size", 0)
    
    # Signature information
    signature = data.get("signature", "Unknown")
    
    # Tags
    tags = data.get("tags", [])
    if isinstance(tags, str):
        tags = [tags] if tags else []
    
    # First seen and last seen dates
    first_seen = data.get("first_seen", "Unknown")
    last_seen = data.get("last_seen", "Unknown")
    
    # Delivery method
    delivery_method = data.get("delivery_method", "Unknown")
    
    # File type description
    file_type_mime = data.get("file_type_mime", "Unknown")
    
    # Intelligence sources
    intelligence = data.get("intelligence", {})
    clamav = intelligence.get("clamav", "Unknown") if intelligence else "Unknown"
    
    # MalwareBazaar link
    link = f"https://bazaar.abuse.ch/sample/{sha256_hash}/"
    
    normalized = {
        "malwarebazaar": {
            "found": True,
            "status": "Hash found in MalwareBazaar database",
            "hash": hash_value,
            "sha256": sha256_hash,
            "md5": md5_hash,
            "sha1": sha1_hash,
            "file_name": file_name,
            "file_type": file_type,
            "file_type_mime": file_type_mime,
            "file_size": file_size,
            "signature": signature,
            "tags": tags,
            "first_seen": first_seen,
            "last_seen": last_seen,
            "delivery_method": delivery_method,
            "clamav": clamav,
            "link": link
        }
    }
    
    logger.info(f"Normalized MalwareBazaar result for {hash_value[:16]}...")
    return normalized

