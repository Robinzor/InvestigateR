"""
MalwareBazaar query module - handles API communication
"""
import aiohttp
import asyncio
import ssl
import logging
from typing import Optional, Dict, Any

logger = logging.getLogger(__name__)

MALWAREBAZAAR_API_URL = "https://mb-api.abuse.ch/api/v1/"


async def query_malwarebazaar_async(hash_value: str, api_key: str = "") -> Optional[Dict[str, Any]]:
    """
    Query MalwareBazaar API for hash information.
    
    Args:
        hash_value: SHA256, SHA1, MD5, or ssdeep hash to query
        api_key: API key (required)
        
    Returns:
        Raw API response data: {"raw_data": {...}, "observable": "..."}
    """
    if not hash_value:
        logger.warning("MalwareBazaar query requires a hash value")
        return {
            "raw_data": {},
            "observable": "",
            "found": False,
            "error": "Hash value is required"
        }
    
    if not api_key:
        logger.warning("MalwareBazaar API key is required")
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": "API key is required. Get one at https://bazaar.abuse.ch/api/"
        }
    
    # Clean hash value (remove whitespace)
    hash_value = hash_value.strip()
    
    # Detect hash type
    # MD5: 32 hex chars, SHA1: 40 hex chars, SHA256: 64 hex chars
    # ssdeep: variable length, contains colons (format: "blocksize:hash1:hash2")
    hash_length = len(hash_value)
    is_ssdeep = ':' in hash_value
    
    if is_ssdeep:
        # ssdeep hash - keep as-is (case sensitive, contains colons)
        logger.info(f"Detected ssdeep hash format")
    elif hash_length in [32, 40, 64]:
        # Standard hash (MD5, SHA1, SHA256) - convert to uppercase
        hash_value = hash_value.upper()
    else:
        logger.warning(f"Invalid hash format for MalwareBazaar query (length: {hash_length}, ssdeep: {is_ssdeep})")
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": f"Invalid hash format. Supported: MD5 (32), SHA1 (40), SHA256 (64), or ssdeep"
        }
    
    if is_ssdeep:
        logger.info(f"Querying MalwareBazaar for ssdeep hash: {hash_value[:30]}...")
    else:
        logger.info(f"Querying MalwareBazaar for hash: {hash_value[:16]}...")
    
    # Prepare form data
    # For ssdeep, we might need to use a different approach
    # Try using "hash" parameter first (works for MD5, SHA1, SHA256)
    # If it's ssdeep and fails, we'll handle it in the response
    data = {
        "query": "get_info",
        "hash": hash_value
    }
    
    # Note: MalwareBazaar API might not support direct ssdeep queries via "get_info"
    # ssdeep is typically used for similarity matching, not direct lookups
    
    # Prepare headers (API key is required)
    headers = {
        "User-Agent": "investigateR/1.0",
        "Auth-Key": api_key
    }
    
    timeout = aiohttp.ClientTimeout(total=10, connect=5)

    # Create SSL context that doesn't verify certificates
    # Note: abuse.ch services sometimes have certificate chain issues, so we disable
    # verification to ensure connectivity. This is acceptable for threat intelligence APIs.
    ssl_context = ssl.create_default_context()
    ssl_context.check_hostname = False
    ssl_context.verify_mode = ssl.CERT_NONE
    
    try:
        connector = aiohttp.TCPConnector(ssl=ssl_context)
        async with aiohttp.ClientSession(timeout=timeout, connector=connector) as session:
            async with session.post(
                MALWAREBAZAAR_API_URL,
                data=data,
                headers=headers
            ) as response:
                if response.status == 200:
                    try:
                        json_response = await response.json()
                        logger.debug(f"MalwareBazaar API response received: {json_response}")
                        
                        # Check query status
                        query_status = json_response.get("query_status", "unknown")
                        logger.debug(f"MalwareBazaar query_status: {query_status}")
                        
                        if query_status == "ok":
                            data_list = json_response.get("data", [])
                            logger.debug(f"MalwareBazaar data list length: {len(data_list) if data_list else 0}")
                            
                            if data_list and len(data_list) > 0:
                                # Hash found in database
                                hash_display = hash_value[:30] if is_ssdeep else hash_value[:16]
                                logger.info(f"Hash found in MalwareBazaar: {hash_display}...")
                                return {
                                    "raw_data": data_list[0],  # First result
                                    "observable": hash_value,
                                    "found": True
                                }
                            else:
                                # No data returned
                                hash_display = hash_value[:30] if is_ssdeep else hash_value[:16]
                                logger.info(f"No data in response for hash: {hash_display}...")
                                return {
                                    "raw_data": {"query_status": "no_results"},
                                    "observable": hash_value,
                                    "found": False
                                }
                        elif query_status == "hash_not_found":
                            hash_display = hash_value[:30] if is_ssdeep else hash_value[:16]
                            logger.info(f"Hash not found in MalwareBazaar: {hash_display}...")
                            return {
                                "raw_data": {"query_status": "hash_not_found"},
                                "observable": hash_value,
                                "found": False
                            }
                        elif query_status == "illegal_hash":
                            # This happens when the hash format is not supported for direct queries
                            if is_ssdeep:
                                logger.warning(f"MalwareBazaar does not support direct ssdeep hash queries via get_info")
                                return {
                                    "raw_data": {"query_status": "illegal_hash"},
                                    "observable": hash_value,
                                    "found": False,
                                    "error": "MalwareBazaar API does not support direct ssdeep hash queries. ssdeep is used for similarity matching in search results, not direct lookups. Please use MD5, SHA1, or SHA256 for direct hash queries."
                                }
                            else:
                                logger.warning(f"MalwareBazaar returned illegal_hash status for hash: {hash_value[:16]}...")
                                return {
                                    "raw_data": {"query_status": "illegal_hash"},
                                    "observable": hash_value,
                                    "found": False,
                                    "error": f"Invalid hash format. MalwareBazaar only supports MD5 (32), SHA1 (40), or SHA256 (64) for direct queries."
                                }
                        else:
                            logger.warning(f"MalwareBazaar query status: {query_status}, full response: {json_response}")
                            return {
                                "raw_data": json_response,
                                "observable": hash_value,
                                "found": False,
                                "query_status": query_status,
                                "error": f"Unexpected query status: {query_status}"
                            }
                    except Exception as e:
                        logger.error(f"Failed to parse MalwareBazaar JSON response: {e}", exc_info=True)
                        return {
                            "raw_data": {},
                            "observable": hash_value,
                            "found": False,
                            "error": f"Failed to parse response: {str(e)}"
                        }
                elif response.status == 401:
                    response_text = await response.text()
                    logger.warning(f"MalwareBazaar API returned 401 Unauthorized: {response_text[:200]}")
                    return {
                        "raw_data": {},
                        "observable": hash_value,
                        "found": False,
                        "error": f"Unauthorized - invalid or missing API key. Response: {response_text[:100]}"
                    }
                elif response.status == 404:
                    hash_display = hash_value[:30] if is_ssdeep else hash_value[:16]
                    logger.debug(f"Hash not found in MalwareBazaar: {hash_display}...")
                    return {
                        "raw_data": {"query_status": "hash_not_found"},
                        "observable": hash_value,
                        "found": False
                    }
                else:
                    logger.warning(f"MalwareBazaar API returned status {response.status}")
                    try:
                        error_text = await response.text()
                        logger.debug(f"Error response: {error_text}")
                    except Exception:
                        pass
                    return {
                        "raw_data": {},
                        "observable": hash_value,
                        "found": False,
                        "error": f"API returned status {response.status}"
                    }
                    
    except asyncio.TimeoutError:
        hash_display = hash_value[:30] if is_ssdeep else hash_value[:16]
        logger.warning(f"Timeout querying MalwareBazaar for {hash_display}...")
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": "Request timed out"
        }
    except aiohttp.ClientConnectorError as e:
        logger.error(f"Connection error while querying MalwareBazaar: {e}")
        if "SSL" in str(e) or "CERTIFICATE" in str(e):
            return {
                "raw_data": {},
                "observable": hash_value,
                "found": False,
                "error": "SSL certificate verification failed for MalwareBazaar API. This may be a temporary certificate issue."
            }
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": f"Could not connect to MalwareBazaar API: {str(e)}"
        }
    except aiohttp.ClientError as e:
        logger.error(f"Network error while querying MalwareBazaar: {e}")
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": f"Network error: {str(e)}"
        }
    except Exception as e:
        logger.error(f"Unexpected error while querying MalwareBazaar: {e}", exc_info=True)
        return {
            "raw_data": {},
            "observable": hash_value,
            "found": False,
            "error": f"Error: {str(e)}"
        }

