<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestigateR</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        /* Dark Mode Variables */
        :root {
            --bg-color: #181a1b;
            --text-color: #e8e6e3;
            --card-bg: #1c1e1f;
            --card-border: #2d2f30;
            --table-bg: #1c1e1f;
            --table-border: #2d2f30;
            --table-hover: #2d2f30;
            --input-bg: #1c1e1f;
            --input-border: #2d2f30;
            --input-text: #e8e6e3;
            --modal-bg: #1c1e1f;
            --modal-border: #2d2f30;
            --alert-bg: #2d2f30;
            --alert-border: #3d3f40;
            --link-color: #58a6ff;
            --link-hover: #79b8ff;
            --ipinfo-color: #17a2b8;
            --abuseipdb-color: #4e7e14;
            --urlscan-color: #2c3e50;
            --shodan-color: #000000; /* Black */
            --reversedns-color: #6c757d;
            --virustotal-color: #007bff;
            --whois-color: #ff7b7b;
            --sans-color: #781400;
        }

        /* Light Mode Variables (will be overridden by dark mode) */
        [data-theme="light"] {
            --bg-color: #ffffff;
            --text-color: #212529;
            --card-bg: #ffffff;
            --card-border: #dee2e6;
            --table-bg: #ffffff;
            --table-border: #dee2e6;
            --table-hover: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-text: #212529;
            --modal-bg: #ffffff;
            --modal-border: #dee2e6;
            --alert-bg: #f8f9fa;
            --alert-border: #dee2e6;
            --link-color: #007bff;
            --link-hover: #0056b3;
        }

        /* Base Styles */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-color: var(--card-border);
        }

        /* Table Styles */
        .table {
            color: var(--text-color);
            background-color: var(--table-bg);
        }

        .table th,
        .table td {
            border-color: var(--table-border);
        }

        .table-hover tbody tr:hover {
            background-color: var(--table-hover);
        }

        /* Form Styles */
        .form-control {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--input-text);
        }

        .form-control:focus {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--input-text);
        }

        /* Modal Styles */
        .modal-content {
            background-color: var(--modal-bg);
            border-color: var(--modal-border);
        }

        /* Alert Styles */
        .alert {
            background-color: var(--alert-bg);
            border-color: var(--alert-border);
        }

        /* Link Styles */
        a {
            color: var(--link-color);
        }

        a:hover {
            color: var(--link-hover);
        }

        /* Standardized Color Scheme - matches config.py TOOL_COLORS */
        :root {
            --hash-color: #4B9CD3;
            --ip-color: #28a745;
            --domain-color: #ffc107;
            --url-color: #dc3545;
            --loading-color: #6c757d;
            /* Tool colors from config.py */
            --abuseipdb-color: #4e7e14;
            --virustotal-color: #4B9CD3;
            --ipinfo-color: #0095E5; /* rgb(0, 149, 229) */
            --greynoise-color: #808080; /* Gray */
            --reversedns-color: #fd7e14;
            --crtsh-color: #00B373;
            --shodan-internetdb-color: #000000; /* Black */
            --shodan-color: #000000; /* Black - Alias for compatibility */
            --whois-color: #ff7b7b;
            --opencti-color: #004085; /* Dark blue */
            --urlscan-search-color: #2c3e50;
            --urlscan-scan-color: #2c3e50;
            --urlscan-color: #2c3e50; /* Alias for compatibility */
            --waybackmachine-color: #ffc107;
            --dns-records-color: #6610f2;
            --sans-color: #781400;
            --alienvault-otx-color: #0012b3;
            --alienvault-iprep-color: #0012b3;
            --abusech-color: #ff6b35;
            --ipblocklists-color: #8b0000;
            --domainblocklists-color: #8b0000;
            --phishtank-color: #dc3545;
            --openphish-color: #9c27b0;
            --googlesafebrowsing-color: #4285F4;
            --urlquery-color: #0e131f;
            --malwarebazaar-color: #ff6b35;
            --hybridanalysis-color: #00a8ff;
            --urlhaus-color: #d9534f;
            --threatfox-color: #ff6b35;
        }

        /* Observable Type Colors */
        .hash-header {
            color: var(--hash-color);
            background: none;
        }
        .ip-header {
            color: var(--ip-color);
            background: none;
        }
        .domain-header {
            color: var(--domain-color);
            background: none;
        }
        .url-header {
            color: var(--url-color);
            background: none;
        }

        /* Module Header Colors */
        .virustotal-box .card-header {
            background-color: var(--virustotal-color) !important;
            color: white;
            border-bottom: 3px solid var(--virustotal-color);
        }
        .ip-info-box .card-header {
            background-color: var(--ipinfo-color) !important;
            color: white;
            border-bottom: 3px solid var(--ipinfo-color);
        }
        .hash-info-box .card-header {
            background-color: var(--virustotal-color) !important;
            color: white;
            border-bottom: 3px solid var(--virustotal-color);
        }
        .reversedns-box .card-header {
            background-color: var(--reversedns-color) !important;
            color: white;
            border-bottom: 3px solid var(--reversedns-color);
        }
        .crtsh-box .card-header {
            background-color: var(--crtsh-color) !important;
            color: white;
            border-bottom: 3px solid var(--crtsh-color);
        }
        .abuseipdb-box .card-header {
            background-color: var(--abuseipdb-color) !important;
            color: white;
            border-bottom: 3px solid var(--abuseipdb-color);
        }
        .whois-box .card-header {
            background-color: var(--whois-color) !important;
            color: white;
            border-bottom: 3px solid var(--whois-color);
        }

        /* Loading States */
        .card-header.bg-info {
            background-color: var(--virustotal-color) !important;
        }
        .card-header.bg-primary {
            background-color: var(--ipinfo-color) !important;
        }
        .card-header.bg-success {
            background-color: var(--whois-color) !important;
        }
        .card-header.bg-warning {
            background-color: var(--crtsh-color) !important;
        }
        .card-header.bg-danger {
            background-color: var(--abuseipdb-color) !important;
        }
        .card-header.bg-dark {
            background-color: var(--virustotal-color) !important;
        }
        .card-header.bg-secondary {
            background-color: var(--url-color) !important;
        }

        /* Risk Score Colors */
        .risk-high {
            color: #dc3545;
        }
        .risk-medium {
            color: #ffc107;
        }
        .risk-low {
            color: #28a745;
        }
        .tool-checkbox {
            margin-right: 10px;
        }
        .container {
            max-width: 100%;
            width: 100%;
            padding-left: 15px;
            padding-right: 15px;
        }
        .results-container {
            width: 100%;
            max-width: 100%;
            margin-top: 20px;
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--link-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Observable cards - scale based on screen size, max 2.4x width (1200px) */
        .results-container .card.observable-card {
            height: auto;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            min-width: 500px;
        }
        
        /* Regular cards keep fixed size */
        .results-container .card:not(.observable-card) {
            height: auto;
            display: flex;
            flex-direction: column;
            width: 500px;
            max-width: 500px;
            min-width: 500px;
        }
        
        .results-container .card .card-body {
            flex: 1;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }
        
        .results-container .card .card-header {
            flex-shrink: 0;
        }
        
        /* Ensure tool cards within observable cards also have fixed size */
        .results-container .observable-card .card {
            height: auto;
        }
        
        /* Tool cards (utils) within observable cards - scrollbar if height > 500px */
        .results-container .observable-card .card-body .row .card {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar styling for tool cards */
        .results-container .observable-card .card-body .row .card::-webkit-scrollbar {
            width: 8px;
        }
        
        .results-container .observable-card .card-body .row .card::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 4px;
        }
        
        .results-container .observable-card .card-body .row .card::-webkit-scrollbar-thumb {
            background: var(--link-color);
            border-radius: 4px;
        }
        
        .results-container .observable-card .card-body .row .card::-webkit-scrollbar-thumb:hover {
            background: var(--link-hover);
        }
        
        /* Make sure rows have equal height and proper wrapping */
        .results-container .row {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            gap: 20px;
        }
        
        /* Observable cards should be side by side */
        .results-container .row > [class*="col-"] {
            display: flex;
            flex-direction: column;
        }
        
        /* Grid layout for tool cards within observable cards - UNIFORM styling */
        .observable-card .tool-cards-row,
        .observable-card .card-body .row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            box-sizing: border-box;
            margin-left: 0 !important;
            margin-right: 0 !important;
            margin-top: 0;
            margin-bottom: 0;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        /* Ensure cards respect their column classes - UNIFORM padding/margin for ALL tool cards */
        .observable-card .tool-cards-row > [class*="col-"],
        .observable-card .card-body .row > [class*="col-"],
        .observable-card .tool-cards-row > .tool-card-col {
            flex: 0 0 auto;
            margin-left: 0 !important;
            margin-right: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            box-sizing: border-box;
        }
        
        /* Remove Bootstrap's default column padding for tool cards */
        .observable-card [class*="col-md-"],
        .observable-card [class*="col-lg-"] {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        /* URLScan boxes need more space - ensure they don't shrink */
        .observable-card .tool-cards-row .urlscan-box,
        .observable-card .card-body .row .urlscan-box {
            flex-shrink: 0;
        }
        
        /* Ensure tool cards themselves don't overflow */
        .observable-card .tool-cards-row .card {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }
        
        /* URLScan boxes should not be too narrow and need more space */
        .observable-card .tool-cards-row .urlscan-box {
            min-width: 400px;
        }
        
        @media (max-width: 991px) {
            .observable-card .tool-cards-row .urlscan-box {
                min-width: 100%;
            }
        }
        
        .results-container .row > [class*="col-"] {
            display: flex;
            flex-direction: column;
            padding: 0;
            flex: 0 0 auto;
            width: auto;
            max-width: none;
        }
        
        /* Observable cards in columns should scale */
        .results-container .row > .col-md-6 > .card.observable-card {
            width: 100%;
            max-width: 1200px;
            min-width: 500px;
        }
        
        .results-container .row > [class*="col-"] > .card.observable-card {
            flex: 1;
            width: 100%;
            max-width: 1200px;
            min-width: 500px;
        }
        
        .results-container .row > [class*="col-"] > .card:not(.observable-card) {
            flex: 1;
            width: 500px;
            max-width: 500px;
            min-width: 500px;
        }
        
        /* Ensure cards stay within their column boundaries */
        .results-container #streaming-results {
            width: 100%;
        }
        
        .results-container #streaming-results > .row {
            margin-bottom: 20px;
        }
        
        .results-container #streaming-results > .row:first-child {
            margin-top: 0;
        }
        
        .results-container #streaming-results > .row > [class*="col-"] {
            margin-bottom: 0;
        }
        
        /* Group header styling */
        .group-header {
            width: 100%;
            padding: 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .group-header h4 {
            margin: 0;
            color: var(--text-color);
            font-weight: 600;
        }
        
        /* Search box styling for scrollable cards */
        .scrollable-card-search {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--card-bg);
            padding: 5px 0;
            margin-bottom: 10px;
        }
        
        .scrollable-card-search .form-control-sm {
            max-width: 300px;
        }
        
        .scrollable-card-container {
            position: relative;
            overflow: visible;
            max-height: none;
        }
        
        .results-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .results-controls label {
            margin-bottom: 0;
            margin-right: 5px;
        }
        
        
        /* Custom column classes for 5 columns */
        @media (min-width: 768px) {
            .col-md-custom-5 {
                flex: 0 0 20%;
                max-width: 20%;
            }
        }
        .table-container {
            overflow: visible;
        }
        .risk-score {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .risk-high {
            background-color: #dc3545;
            color: white;
        }
        .risk-medium {
            background-color: #ffc107;
            color: black;
        }
        .risk-low {
            background-color: #28a745;
            color: white;
        }
        .external-link {
            color: #007bff;
            text-decoration: none;
        }
        .external-link:hover {
            text-decoration: underline;
        }
        .api-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        .api-status.valid {
            background-color: #28a745;
        }
        .api-status.invalid {
            background-color: #dc3545;
        }
        .api-status.unknown {
            background-color: #ff8c00; /* Orange */
        }
        .api-status.optional {
            background-color: #17a2b8;
        }
        .api-status-container {
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.25rem;
            min-height: 3rem;
            border-bottom: none;
            background: none;
            position: relative;
        }
        .observable-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            color: #0d6efd;
            letter-spacing: -0.5px;
            background: none;
            flex: 1;
            padding-right: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }
        .observable-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            border: 2px solid #6c757d;
            color: #6c757d;
            font-weight: 500;
            background: none;
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        /* Pyramid of Pain colors */
        .network-header {
            color: #FFE5B4; /* Peach for Network/Host Artifacts (Annoying) */
        }
        .tools-header {
            color: #FFA500; /* Orange for Tools (Challenging) */
        }
        .ttps-header {
            color: #FF0000; /* Red for TTPs (Tough) */
        }
        /* Card Styling */
        .card {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.25rem;
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px 8px 0 0;
            padding: 1rem 1.25rem;
        }
        .card .card-body {
            padding: 1.25rem;
        }
        
        /* Observable card body should have consistent padding */
        .observable-card .card-body {
            padding: 1rem 1.25rem;
            /* Remove max-height and overflow to allow full page scrolling */
        }
        
        /* Module-specific card styling */
        .virustotal-box .card-header,
        .ip-info-box .card-header,
        .hash-info-box .card-header,
        .reversedns-box .card-header,
        .crtsh-box .card-header,
        .abuseipdb-box .card-header,
        .whois-box .card-header {
            border-bottom: 2px solid rgba(0,0,0,0.1);
            position: relative;
        }
        .virustotal-box .card-header:after,
        .ip-info-box .card-header:after,
        .hash-info-box .card-header:after,
        .reversedns-box .card-header:after,
        .crtsh-box .card-header:after,
        .abuseipdb-box .card-header:after,
        .whois-box .card-header:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: inherit;
            opacity: 0.8;
        }

        /* Table styling improvements */
        .table-responsive {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 4px;
            margin-top: 1rem;
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            border-top: none;
            background: rgba(0,0,0,0.02);
            font-weight: 600;
        }
        .table td {
            vertical-align: middle;
        }
        
        /* Risk score badges */
        .risk-score {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }
        .risk-high {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .risk-medium {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        .risk-low {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        /* Button improvements */
        .btn-outline-primary,
        .btn-outline-secondary,
        .btn-outline-danger,
        .btn-outline-success,
        .btn-outline-info,
        .btn-outline-warning,
        .btn-outline-dark {
            border-width: 2px;
            font-weight: 500;
        }
        
        /* Observable header improvements */
        .observable-header {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            padding-right: 0.5rem;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .observable-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
            letter-spacing: 0.3px;
            border: 2px solid currentColor;
            opacity: 0.8;
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        /* Remove old observable container styles */
        .observable-container {
            display: none;
        }

        /* Information Box Headers */
        .info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.25rem;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
        }
        
        /* Specific Information Box Colors */
        .virustotal-header {
            color: white;
        }
        .ip-header {
            color: white;
        }
        .domain-header {
            color: white;
        }
        .hash-header {
            color: white;
        }

        /* Content Styling */
        .card-body {
            background-color: var(--card-bg);
            border-radius: 0 0 8px 8px;
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            font-weight: 600;
            color: var(--text-color);
        }
        .table td {
            color: var(--text-color);
        }

        /* Utility Classes */
        .mb-2 {
            margin-bottom: 1rem !important;
        }
        .h-100 {
            height: 100% !important;
        }
        /* URLScan box styling - ensure it has enough width */
        .urlscan-box {
            min-width: 400px;
        }
        .urlscan-box .table {
            font-size: 0.9rem;
        }
        .urlscan-box .table th,
        .urlscan-box .table td {
            padding: 0.4rem;
            border-color: var(--table-border);
            white-space: nowrap;
        }
        .urlscan-box .table td:first-child {
            white-space: normal;
        }
        .urlscan-box .table td:nth-child(2) {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .screenshot-preview {
            cursor: pointer;
            margin-left: 5px;
            color: #007bff;
            position: relative;
            display: inline-block;
        }
        .screenshot-preview:hover {
            color: #0056b3;
        }
        .screenshot-preview .preview-image {
            display: none;
            position: fixed;
            width: 300px;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 9999;
            background: white;
            padding: 5px;
            pointer-events: none;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .screenshot-preview:hover .preview-image {
            display: block;
        }
        .screenshot-preview .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .screenshot-modal .modal-dialog {
            max-width: 90%;
        }
        .screenshot-modal .modal-body {
            text-align: center;
        }
        .screenshot-modal .modal-body img {
            max-width: 100%;
            height: auto;
        }
        /* Hide pagination elements */
        .dataTables_paginate,
        .paginate_button,
        .page-item,
        .previous,
        .next {
            display: none !important;
        }

        /* Hide DataTables info */
        .dataTables_info {
            display: none !important;
        }

        /* Hide DataTables length menu */
        .dataTables_length {
            display: none !important;
        }

        /* Hide DataTables filter */
        .dataTables_filter {
            display: none !important;
        }

        /* API Status Indicators */
        .api-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        .api-status.valid {
            background-color: #28a745;
        }
        .api-status.invalid {
            background-color: #dc3545;
        }
        .api-status.unknown {
            background-color: #ff8c00; /* Orange */
        }

        /* Compact Tools Layout */
        .form-check {
            margin-right: 10px;
            margin-bottom: 5px;
        }
        .form-check-label {
            font-size: 0.9rem;
        }
        .form-check-input {
            margin-top: 0.2rem;
        }
        .gap-2 {
            gap: 0.5rem;
        }
        .result-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .save-options {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
    <script>
        // Dynamically generated tool mappings from modules
        const toolMappings = {
            {% for module in modules %}
            '{{ module.display_name }}': '{{ module.data_key }}',
            {% endfor %}
            // Special mappings for display names that differ
            'WHOIS Information': 'rdap',
            'WHOIS': 'rdap',
            'Wayback Machine': 'wayback_machine',
            'CRT.sh': 'crtsh',
            'IPinfo': 'ipinfo',
            'Reverse DNS': 'reversedns',
            'Shodan InternetDB': 'shodan_internetdb',
            'Shodan': 'shodan_internetdb',
        };
        
        // Tool icon mappings
        const toolIcons = {
            {% for module in modules %}
            '{{ module.display_name }}': '{{ module.icon }}',
            {% endfor %}
            // Special mappings
            'WHOIS Information': 'fa-globe',
            'WHOIS': 'fa-globe',
            'Wayback Machine': 'fa-history',
            'CRT.sh': 'fa-certificate',
            'IPinfo': 'fa-map-marker-alt',
            'Reverse DNS': 'fa-exchange-alt',
            'Shodan InternetDB': 'fa-database',
            'Shodan': 'fa-database',
        };
        
        // Helper function to get tool key from header text
        function getToolKeyFromHeader(headerText) {
            // Try exact match first
            if (toolMappings[headerText]) {
                return toolMappings[headerText];
            }
            // Try partial match
            for (const [header, key] of Object.entries(toolMappings)) {
                if (headerText.includes(header) || header.includes(headerText.split(' ')[0])) {
                    return key;
                }
            }
            return null;
        }
        
        // Set dark mode as default and remove theme toggle functionality
        document.documentElement.setAttribute('data-theme', 'dark');
        
        // Remove theme toggle button
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggleButton = document.querySelector('button[onclick="toggleTheme()"]');
            if (themeToggleButton) {
                themeToggleButton.remove();
            }
        });

        // Load saved theme preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const colors = JSON.parse(localStorage.getItem('customColors') || '{}');
            const root = document.documentElement;
            
            if (colors.hash_color) root.style.setProperty('--hash-color', colors.hash_color);
            if (colors.ip_color) root.style.setProperty('--ip-color', colors.ip_color);
            if (colors.domain_color) root.style.setProperty('--domain-color', colors.domain_color);
            if (colors.url_color) root.style.setProperty('--url-color', colors.url_color);
            if (colors.loading_color) root.style.setProperty('--loading-color', colors.loading_color);
            if (colors.virustotal_color) root.style.setProperty('--virustotal-color', colors.virustotal_color);
            if (colors.ipinfo_color) root.style.setProperty('--ipinfo-color', colors.ipinfo_color);
            if (colors.reversedns_color) root.style.setProperty('--reversedns-color', colors.reversedns_color);
            if (colors.crtsh_color) root.style.setProperty('--crtsh-color', colors.crtsh_color);
            if (colors.urlhaus_color) root.style.setProperty('--urlhaus-color', colors.urlhaus_color);
            if (colors.threatfox_color) root.style.setProperty('--threatfox-color', colors.threatfox_color);
        });
    </script>
</head>
<body>

<div class="container" style="margin-top: 0; padding-top: 10px;">
    <div class="row" style="margin: 0;">
        <div class="col-md-12" style="margin-bottom: 8px;">
            <div class="d-flex justify-content-between align-items-center" style="margin: 0;">
                <h1 class="mb-0" style="margin: 0;">InvestigateR</h1>
                <button type="button" class="btn btn-outline-info btn-sm" id="checkApiKeysBtn" title="Check API Key Status">
                    <i class="fas fa-key"></i> Check API Keys
                </button>
                <a href="{{ url_for('settings') }}" class="btn btn-outline-primary btn-sm">Settings</a>
            </div>
        </div>
    </div>

    <form method="POST">
        <div class="row" style="margin: 0;">
            <!-- Observables - Left side (smaller) -->
            <div class="col-md-4" style="padding-right: 8px;">
                <div class="form-group mb-1" style="margin-bottom: 0.5rem !important;">
                    <label for="observables" style="font-size: 0.9rem; margin-bottom: 0.2rem !important;">Enter observables (one per line):</label>
                    <textarea class="form-control" id="observables" name="observables" rows="2" 
                              placeholder="Enter domains, IPs, URLs, or file hashes (one per line)" required style="font-size: 0.9rem;"></textarea>
                </div>
                <div class="form-group mb-0" style="margin-bottom: 0 !important;">
                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="resetButton">Reset</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="saveResults('json')">
                        <i class="fas fa-save"></i> Save Results
                    </button>
                    <input type="file" id="loadResultsFile" accept=".json" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="loadResultsBtn">
                        <i class="fas fa-folder-open"></i> Load Results
                    </button>
                </div>
            </div>
            
            <!-- Tools - Right side (much wider, almost 2x) -->
            <div class="col-md-8" style="padding-left: 8px;">
                <div class="form-group mb-0" style="margin-top: 0; margin-bottom: 0 !important;">
                    <label class="mb-1" style="font-size: 0.9rem; margin-bottom: 0.2rem !important; display: block;">Tools:</label>
                    <div style="max-height: 180px; overflow-y: auto; overflow-x: visible; border: 1px solid var(--card-border); padding: 4px 6px; border-radius: 4px; background-color: var(--card-bg);">
                        <!-- Tools without API key requirement -->
                        <div style="margin-bottom: 0.4rem !important; margin-top: 0;">
                            <h6 style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.2rem !important; margin-top: 0;"><small><strong>Free Tools</strong></small></h6>
                            <div class="row" style="margin: 0;">
                                {% if modules %}
                                {% set free_modules = [] %}
                                {% for module in modules %}
                                {% set api_key_name = module.api_key_name %}
                                {% set requires_api = module.requires_api_key %}
                                {% if not requires_api and not api_key_name %}
                                    {% set _ = free_modules.append(module) %}
                                {% endif %}
                                {% endfor %}
                                {% for module in free_modules %}
                                <div class="col-md-3 col-lg-2 col-xl-2" style="padding: 1px 3px; white-space: nowrap; overflow: visible; flex: 0 0 auto;">
                                    <div class="form-check" style="margin-bottom: 2px;">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" style="margin-top: 0.2rem;">
                                        <label class="form-check-label" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <!-- Tools with API key requirement -->
                        <div style="margin-top: 0.3rem;">
                            <h6 style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.2rem !important; margin-top: 0;"><small><strong>API Key Required</strong></small></h6>
                            <div class="row" style="margin: 0;">
                                {% if modules %}
                                {% set api_modules = [] %}
                                {% for module in modules %}
                                {% set api_key_name = module.api_key_name %}
                                {% set requires_api = module.requires_api_key %}
                                {% if requires_api and api_key_name %}
                                    {% set _ = api_modules.append({'module': module, 'api_key_name': api_key_name, 'optional': False}) %}
                                {% endif %}
                                {% endfor %}
                                {% for item in api_modules %}
                                {% set module = item.module %}
                                {% set api_key_name = item.api_key_name %}
                                {% set has_api_key = api_keys.get(api_key_name, '') and api_keys.get(api_key_name, '')|trim != '' %}
                                <div class="col-md-3 col-lg-2 col-xl-2" style="padding: 1px 3px; white-space: nowrap; overflow: visible; flex: 0 0 auto;">
                                    {% if api_status.get(api_key_name) == 'valid' %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" style="margin-top: 0.2rem;">
                                        <label class="form-check-label" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            <span class="api-status valid" title="API Key Valid"></span>
                                        </label>
                                    </div>
                                    {% elif api_status.get(api_key_name) == 'invalid' or not has_api_key %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" disabled style="margin-top: 0.2rem;">
                                        <label class="form-check-label text-muted" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            {% if not has_api_key %}
                                            <span class="api-status invalid" title="No API Key"></span>
                                            {% else %}
                                            <span class="api-status invalid" title="API Key Invalid"></span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    {% else %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" disabled style="margin-top: 0.2rem;">
                                        <label class="form-check-label text-muted" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            <span class="api-status unknown" title="API Key Status Unknown"></span>
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <!-- Tools with optional API key -->
                        {% if modules %}
                        {% set optional_api_modules = [] %}
                        {% for module in modules %}
                        {% set api_key_name = module.api_key_name %}
                        {% set requires_api = module.requires_api_key %}
                        {% if not requires_api and api_key_name %}
                            {% set _ = optional_api_modules.append({'module': module, 'api_key_name': api_key_name}) %}
                        {% endif %}
                        {% endfor %}
                        {% if optional_api_modules|length > 0 %}
                        <div style="margin-top: 0.3rem;">
                            <h6 style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.2rem !important; margin-top: 0;"><small><strong>Optional API Key</strong></small></h6>
                            <div class="row" style="margin: 0;">
                                {% for item in optional_api_modules %}
                                {% set module = item.module %}
                                {% set api_key_name = item.api_key_name %}
                                {% set has_api_key = api_keys.get(api_key_name, '') and api_keys.get(api_key_name, '')|trim != '' %}
                                <div class="col-md-3 col-lg-2 col-xl-2" style="padding: 1px 3px; white-space: nowrap; overflow: visible; flex: 0 0 auto;">
                                    {% if api_status.get(api_key_name) == 'valid' %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" style="margin-top: 0.2rem;">
                                        <label class="form-check-label" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            <span class="api-status valid" title="API Key Valid (Optional)"></span>
                                        </label>
                                    </div>
                                    {% elif not has_api_key %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" disabled style="margin-top: 0.2rem;">
                                        <label class="form-check-label text-muted" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            <span class="api-status invalid" title="No API Key (Required)"></span>
                                        </label>
                                    </div>
                                    {% else %}
                                    <div class="form-check" style="margin-bottom: 2px;" data-api-key="{{ api_key_name }}">
                                        <input class="form-check-input" type="checkbox" name="tools" value="{{ module.name }}" id="{{ module.data_key }}" style="margin-top: 0.2rem;">
                                        <label class="form-check-label" for="{{ module.data_key }}" style="font-size: 0.8rem; padding-left: 0.2rem; white-space: nowrap; overflow: visible;">
                                            <i class="fas {{ module.icon }}" style="font-size: 0.75rem;"></i> <span>{{ module.display_name }}</span>
                                            <span class="api-status optional" title="API Key Optional"></span>
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>


    {% if error %}
    <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}

    {% if results or processing_id %}
    <div class="results-container" {% if processing_id %}data-processing-id="{{ processing_id }}"{% endif %}>
        <div class="d-flex align-items-center mt-3">
            <h2 class="mb-0 d-flex align-items-center">
                Results
                <span id="results-timestamp" class="badge badge-light ml-2" style="display:none; font-size: 0.8rem;"></span>
                <span id="results-status" class="alert alert-info py-1 px-2 mb-0 ml-2" style="font-size: 0.85rem; display: none;">
                    <span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>
                </span>
            </h2>
        </div>
        
        <!-- Tabs for switching between Cards and Table view -->
        <ul class="nav nav-tabs mt-2" id="viewTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="cards-tab" data-toggle="tab" href="#cardView" role="tab" aria-controls="cardView" aria-selected="true">
                    <i class="fas fa-th-large"></i> Cards
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="table-tab" data-toggle="tab" href="#tableView" role="tab" aria-controls="tableView" aria-selected="false">
                    <i class="fas fa-table"></i> Tabel
                </a>
            </li>
        </ul>
        
        <!-- Tab content -->
        <div class="tab-content mt-2" id="viewTabContent">
            <!-- Cards View (default/active) -->
            <div class="tab-pane fade show active" id="cardView" role="tabpanel" aria-labelledby="cards-tab">
            {% if processing_id %}
            <div id="streaming-results">
                <!-- Loading cards will be added here via JavaScript -->
            </div>
            {% else %}
            {% for result in results %}
            <div class="card mb-3 observable-card" data-observable="{{ result.observable }}" data-type="{{ result.type }}">
                <div class="card-header">
                    <div class="observable-header {% if result.type == 'Domain' %}domain-header{% elif result.type == 'IP' %}ip-header{% elif result.type == 'URL' %}url-header{% elif result.type == 'Hash' %}hash-header{% endif %}">
                        {{ result.observable }}
                    </div>
                    <div class="observable-type">{{ result.type }}</div>
                </div>
                <div class="card-body">
                    <div class="row tool-cards-row">
{% if result.type == "IP" and "AbuseIPDB" in selected_tools and result.data %}
{% set abuse_data = result.data.abuseipdb if result.data.abuseipdb else {} %}
{% set is_safe = is_module_result_safe(abuse_data, 'abuseipdb') %}
<div class="tool-card-col col-md-4 col-lg-3 mb-2">
    <div class="card h-100 abuseipdb-box" data-tool="abuseipdb" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--abuseipdb-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>AbuseIPDB</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Reports:</strong> {{ result.data.abuseipdb.reports if result.data.abuseipdb else 'N/A' }}</small></p>
                                            <p class="mb-1"><small><strong>Risk Score:</strong> 
                                                <span class="risk-score 
                                                    {% if result.data.abuseipdb and result.data.abuseipdb.get('risk_score') and result.data.abuseipdb.get('risk_score') >= 70 %}risk-high
                                                    {% elif result.data.abuseipdb and result.data.abuseipdb.get('risk_score') and result.data.abuseipdb.get('risk_score') >= 30 %}risk-medium
                                                    {% else %}risk-low{% endif %}">
                                                    {{ result.data.abuseipdb.get('risk_score', 'N/A') if result.data.abuseipdb else 'N/A' }}%
                                                </span>
                                            </small></p>
                                            <p class="mb-1"><small><strong>ISP:</strong> {{ result.data.abuseipdb.isp if result.data.abuseipdb else 'N/A' }}</small></p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Country:</strong> {{ result.data.abuseipdb.country if result.data.abuseipdb else 'N/A' }}</small></p>
                                            <p class="mb-1"><small><strong>Last Reported:</strong> {{ result.data.abuseipdb.last_reported if result.data.abuseipdb else 'N/A' }}</small></p>
                                            {% if result.data.abuseipdb and result.data.abuseipdb.link %}
                                            <a href="{{ result.data.abuseipdb.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--abuseipdb-color);" target="_blank">Details</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if result.type == "IP" and "GreyNoise" in selected_tools and result.data.greynoise %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100">
                                <div class="card-header py-1" style="background-color: var(--greynoise-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-cloud mr-2"></i>GreyNoise</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.greynoise.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.greynoise.error }}</small>
                                    </div>
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Classification:</strong> {{ result.data.greynoise.classification or 'unknown' }}</small>
                                    </p>
                                    {% if result.data.greynoise.name %}
                                    <p class="mb-1">
                                        <small><strong>Actor / Name:</strong> {{ result.data.greynoise.name }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.greynoise.last_seen %}
                                    <p class="mb-1">
                                        <small><strong>Last Seen:</strong> {{ result.data.greynoise.last_seen }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.greynoise.link %}
                                    <a href="{{ result.data.greynoise.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--greynoise-color);" target="_blank">
                                        View on GreyNoise
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if ("AlienVaultOTX" in selected_tools or "AlienVault OTX" in selected_tools) and result.data.alienvault_otx %}
                        {% set is_safe = is_module_result_safe(result.data.alienvault_otx, 'alienvault_otx') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="alienvault_otx" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--alienvault-otx-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>AlienVault OTX</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.alienvault_otx.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.alienvault_otx.error }}</small>
                                    </div>
                                    {% elif result.data.alienvault_otx.found %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-warning">Found in Threat Intelligence</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Pulses:</strong> {{ result.data.alienvault_otx.pulse_count }}</small>
                                    </p>
                                    {% if result.data.alienvault_otx.reputation %}
                                    <p class="mb-1">
                                        <small><strong>Reputation:</strong> {{ result.data.alienvault_otx.reputation }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.alienvault_otx.pulses and result.data.alienvault_otx.pulses|length > 0 %}
                                    <p class="mb-1"><small><strong>Recent Pulses:</strong></small></p>
                                    <ul class="list-unstyled mb-1" style="max-height: 150px; overflow-y: auto;">
                                        {% for pulse in result.data.alienvault_otx.pulses[:5] %}
                                        <li><small>
                                            <strong>{{ pulse.name or 'Unnamed' }}</strong><br>
                                            <span class="text-muted">by {{ pulse.author }}</span><br>
                                            <span class="text-muted">{{ pulse.created }}</span>
                                        </small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not Found</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.alienvault_otx.message or 'No threat intelligence found' }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.alienvault_otx.link %}
                                    <a href="{{ result.data.alienvault_otx.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--alienvault-otx-color);" target="_blank">
                                        View on OTX
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.type == "IP" and ("AlienVaultIPRep" in selected_tools or "AlienVault IP Reputation" in selected_tools) %}
                        {% if result.data.alienvault_iprep %}
                        {% set is_safe = is_module_result_safe(result.data.alienvault_iprep, 'alienvault_iprep') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="alienvault_iprep" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--alienvault-iprep-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>AlienVault IP Reputation</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.alienvault_iprep.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.alienvault_iprep.error }}</small>
                                    </div>
                                    {% elif result.data.alienvault_iprep.in_blacklist %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            {% if result.data.alienvault_iprep.is_malicious %}
                                                <span class="badge badge-danger">Malicious IP</span>
                                            {% else %}
                                                <span class="badge badge-warning">In Blacklist</span>
                                            {% endif %}
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Source:</strong> {{ result.data.alienvault_iprep.source or 'AlienVault IP Reputation Database' }}</small>
                                    </p>
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not in Blacklist</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>IP address not found in AlienVault IP Reputation Database</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.alienvault_iprep.link %}
                                    <a href="{{ result.data.alienvault_iprep.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--alienvault-iprep-color);" target="_blank">
                                        View on AlienVault
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if (result.type == "IP" or result.type == "Domain") and ("AbuseCh" in selected_tools or "Abuse.ch" in selected_tools) %}
                        {% if result.data.abusech %}
                        {% set is_safe = is_module_result_safe(result.data.abusech, 'abusech') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="abusech" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--abusech-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>Abuse.ch</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.abusech.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.abusech.error }}</small>
                                    </div>
                                    {% elif result.data.abusech.in_blacklist %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            {% if result.data.abusech.is_malicious %}
                                                <span class="badge badge-danger">Malicious</span>
                                            {% else %}
                                                <span class="badge badge-warning">In Blacklist</span>
                                            {% endif %}
                                        </small>
                                    </p>
                                    {% if result.data.abusech.feodo_tracker %}
                                    <p class="mb-1">
                                        <small><strong>Feodo Tracker:</strong> <span class="badge badge-danger">Found</span></small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.abusech.ssl_blacklist %}
                                    <p class="mb-1">
                                        <small><strong>SSL Blacklist:</strong> <span class="badge badge-danger">Found</span></small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.abusech.urlhaus %}
                                    <p class="mb-1">
                                        <small><strong>URLhaus:</strong> <span class="badge badge-danger">Found</span></small>
                                    </p>
                                    {% endif %}
                                    <p class="mb-1">
                                        <small><strong>Source:</strong> {{ result.data.abusech.source or 'Abuse.ch' }}</small>
                                    </p>
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not in Blacklist</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.abusech.observable }} not found in Abuse.ch blacklists</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.abusech.link %}
                                    <a href="{{ result.data.abusech.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--abusech-color);" target="_blank">
                                        View on Abuse.ch
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if (result.type == "URL" or result.type == "Domain") and "PhishTank" in selected_tools %}
                        {% if result.data.phishtank %}
                        {% set is_safe = is_module_result_safe(result.data.phishtank, 'phishtank') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="phishtank" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--phishtank-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-fish mr-2"></i>PhishTank</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.phishtank.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.phishtank.error }}</small>
                                    </div>
                                    {% elif result.data.phishtank.in_database %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            {% if result.data.phishtank.is_phishing %}
                                                <span class="badge badge-danger">Verified Phishing</span>
                                            {% else %}
                                                <span class="badge badge-warning">In Database (Not Verified)</span>
                                            {% endif %}
                                        </small>
                                    </p>
                                    {% if result.data.phishtank.phish_id %}
                                    <p class="mb-1">
                                        <small><strong>Phish ID:</strong> {{ result.data.phishtank.phish_id }}</small>
                                    </p>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not in Database</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>URL/Domain not found in PhishTank database</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.phishtank.phish_detail_url %}
                                    <a href="{{ result.data.phishtank.phish_detail_url }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--phishtank-color);" target="_blank">
                                        View on PhishTank
                                    </a>
                                    {% elif result.data.phishtank.link %}
                                    <a href="{{ result.data.phishtank.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--phishtank-color);" target="_blank">
                                        View on PhishTank
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if result.type == "IP" and ("IPBlocklists" in selected_tools or "IP Blocklists" in selected_tools) %}
                        {% if result.data.ipblocklists %}
                        {% set is_safe = is_module_result_safe(result.data.ipblocklists, 'ipblocklists') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="ipblocklists" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--ipblocklists-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-ban mr-2"></i>IP Blocklists</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.ipblocklists.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.ipblocklists.error }}</small>
                                    </div>
                                    {% elif result.data.ipblocklists.in_blacklist %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            <span class="badge badge-danger">Found in {{ result.data.ipblocklists.total_blacklists_found }} Blacklist(s)</span>
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Checked:</strong> {{ result.data.ipblocklists.total_blacklists_checked }} blacklists</small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Failed:</strong> {{ result.data.ipblocklists.total_blacklists_failed|default(0) }} blacklists</small>
                                    </p>
                                    {% if result.data.ipblocklists.found_in_names %}
                                    <p class="mb-1"><small><strong>Found in:</strong></small></p>
                                    <ul class="list-unstyled mb-1" style="max-height: 150px; overflow-y: auto; font-size: 0.75rem;">
                                        {% for name in result.data.ipblocklists.found_in_names %}
                                        <li><small><span class="badge badge-danger">{{ name }}</span></small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not in Blacklists</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>IP not found in {{ result.data.ipblocklists.total_blacklists_checked }} checked blacklists</small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Failed:</strong> {{ result.data.ipblocklists.total_blacklists_failed|default(0) }} blacklists</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.ipblocklists.link %}
                                    <a href="{{ result.data.ipblocklists.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--ipblocklists-color);" target="_blank">
                                        View Details
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        {% if result.type == "Domain" and ("DomainBlocklists" in selected_tools or "Domain Blocklists" in selected_tools) %}
                        {% if result.data.domainblocklists %}
                        {% set is_safe = is_module_result_safe(result.data.domainblocklists, 'domainblocklists') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="domainblocklists" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--domainblocklists-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-ban mr-2"></i>Domain Blocklists</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.domainblocklists.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.domainblocklists.error }}</small>
                                    </div>
                                    {% elif result.data.domainblocklists.in_blacklist %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            <span class="badge badge-danger">Found in {{ result.data.domainblocklists.total_blacklists_found }} Blacklist(s)</span>
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Checked:</strong> {{ result.data.domainblocklists.total_blacklists_checked }} blacklists</small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Failed:</strong> {{ result.data.domainblocklists.total_blacklists_failed|default(0) }} blacklists</small>
                                    </p>
                                    {% if result.data.domainblocklists.found_in_names %}
                                    <p class="mb-1"><small><strong>Found in:</strong></small></p>
                                    <ul class="list-unstyled mb-1" style="max-height: 150px; overflow-y: auto; font-size: 0.75rem;">
                                        {% for name in result.data.domainblocklists.found_in_names %}
                                        <li><small><span class="badge badge-danger">{{ name }}</span></small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small class="text-muted">
                                            <span class="badge badge-success">Safe</span>
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small>Domain not found in {{ result.data.domainblocklists.total_blacklists_checked }} checked blacklists</small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Failed:</strong> {{ result.data.domainblocklists.total_blacklists_failed|default(0) }} blacklists</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.domainblocklists.link %}
                                    <a href="{{ result.data.domainblocklists.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--domainblocklists-color);" target="_blank">
                                        View Details
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if (result.type == "URL" or result.type == "Domain") and "OpenPhish" in selected_tools %}
                        {% if result.data.openphish %}
                        {% set is_safe = is_module_result_safe(result.data.openphish, 'openphish') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="openphish" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--openphish-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-virus mr-2"></i>OpenPhish</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.openphish.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.openphish.error }}</small>
                                    </div>
                                    {% elif result.data.openphish.is_phishing %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            <span class="badge badge-danger">Phishing Detected</span>
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small>URL/Domain found in OpenPhish feed</small>
                                    </p>
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not in OpenPhish</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>URL/Domain not found in OpenPhish feed</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.openphish.link %}
                                    <a href="{{ result.data.openphish.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--openphish-color);" target="_blank">
                                        View on OpenPhish
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if (result.type == "URL" or result.type == "Domain") and "GoogleSafeBrowsing" in selected_tools %}
                        {% if result.data.googlesafebrowsing %}
                        {% set is_safe = is_module_result_safe(result.data.googlesafebrowsing, 'googlesafebrowsing') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="googlesafebrowsing" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--googlesafebrowsing-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>Google Safe Browsing</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.googlesafebrowsing.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.googlesafebrowsing.error }}</small>
                                    </div>
                                    {% elif result.data.googlesafebrowsing.safe %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Safe</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.googlesafebrowsing.message }}</small>
                                    </p>
                                    {% if result.data.googlesafebrowsing.checked_urls and result.data.googlesafebrowsing.checked_urls|length > 1 %}
                                    <p class="mb-1">
                                        <small><strong>Checked URLs:</strong> {{ result.data.googlesafebrowsing.checked_urls|length }} URL(s)</small>
                                    </p>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-danger">Threat Detected</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>Threat Types:</strong></small>
                                    </p>
                                    <p class="mb-1">
                                        {% for threat_type in result.data.googlesafebrowsing.threat_types %}
                                        <span class="badge badge-danger mr-1">{{ threat_type }}</span>
                                        {% endfor %}
                                    </p>
                                    {% if result.data.googlesafebrowsing.platform_types %}
                                    <p class="mb-1">
                                        <small><strong>Platforms:</strong> {{ result.data.googlesafebrowsing.platform_types|join(', ') }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.googlesafebrowsing.flagged_urls %}
                                    <p class="mb-1">
                                        <small><strong>Flagged URLs:</strong></small>
                                    </p>
                                    <ul class="mb-1 pl-3" style="font-size: 0.85rem;">
                                        {% for url in result.data.googlesafebrowsing.flagged_urls %}
                                        <li><small>{{ url }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    <p class="mb-1">
                                        <small>{{ result.data.googlesafebrowsing.message }}</small>
                                    </p>
                                    {% endif %}
                                    <a href="https://transparencyreport.google.com/safe-browsing/search?url={{ result.data.googlesafebrowsing.observable|urlencode }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--googlesafebrowsing-color);" target="_blank">
                                        View on Google Safe Browsing
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if (result.type == "URL" or result.type == "Domain") and "URLQuery" in selected_tools %}
                        {% if result.data.urlquery %}
                        {% set is_safe = is_module_result_safe(result.data.urlquery, 'urlquery') %}
                        <div class="col-md-6 col-lg-6 mb-2">
                            <div class="card h-100" data-tool="urlquery" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--urlquery-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-search mr-2"></i>URLQuery ({{ result.data.urlquery.total_hits or 0 }} report{{ 's' if (result.data.urlquery.total_hits or 0) != 1 else '' }})</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.urlquery.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.urlquery.error }}</small>
                                    </div>
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            {% if result.data.urlquery.safe %}
                                                <span class="badge badge-success">Undetected</span>
                                            {% else %}
                                                <span class="badge badge-danger">Threat Detected</span>
                                            {% endif %}
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.urlquery.message }}</small>
                                    </p>
                                    {% if result.data.urlquery.verdicts is not none and result.data.urlquery.verdicts|length > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Verdicts:</strong></small>
                                    </p>
                                    <p class="mb-1">
                                        {% for verdict in result.data.urlquery.verdicts %}
                                        <span class="badge badge-danger mr-1">{{ verdict }}</span>
                                        {% endfor %}
                                    </p>
                                    {% endif %}
                                    
                                    {% if result.data.urlquery.reports and result.data.urlquery.reports is not none and result.data.urlquery.reports|length > 0 %}
                                    <div class="table-responsive scrollable-card-container" style="max-height: 400px;">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th><small>Date</small></th>
                                                    <th><small>URL</small></th>
                                                    <th><small>IP</small></th>
                                                    <th><small>Detections</small></th>
                                                    <th class="text-center"><small>Link</small></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for report in result.data.urlquery.reports %}
                                                <tr>
                                                    <td><small>{{ report.date }}</small></td>
                                                    <td><small>{{ report.url|truncate(30) }}</small></td>
                                                    <td><small>{{ report.ip }}</small></td>
                                                    <td>
                                                        <small>
                                                            {% if report.detections is not none and report.detections|length > 0 %}
                                                                <span class="badge badge-danger">{{ report.detections|length }}</span>
                                                            {% else %}
                                                                <span class="badge badge-success">0</span>
                                                            {% endif %}
                                                        </small>
                                                    </td>
                                                    <td class="text-center">
                                                        {% if report.report_url %}
                                                        <a href="{{ report.report_url }}" class="btn btn-sm py-0 text-white" style="background-color: var(--urlquery-color);" target="_blank">
                                                            <i class="fas fa-external-link-alt"></i>
                                                        </a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {% if result.data.urlquery.reports and result.data.urlquery.reports|length > 0 and result.data.urlquery.reports[0].detections is not none and result.data.urlquery.reports[0].detections|length > 0 %}
                                    <div class="mt-2">
                                        <p class="mb-1"><small><strong>Detections:</strong></small></p>
                                        <ul class="mb-1 pl-3" style="font-size: 0.85rem;">
                                            {% for detection in result.data.urlquery.reports[0].detections %}
                                            <li>
                                                <small>
                                                    <strong>{{ detection.sensor_name }}</strong> ({{ detection.sensor_type }}): 
                                                    <span class="badge badge-danger">{{ detection.verdict }}</span> - 
                                                    {{ detection.alert }}
                                                    {% if detection.link %}
                                                    <a href="{{ detection.link }}" target="_blank" class="ml-1"><i class="fas fa-external-link-alt"></i></a>
                                                    {% endif %}
                                                </small>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    
                                    <a href="https://urlquery.net/search?q={{ (result.data.urlquery.query_string or result.data.urlquery.observable)|urlencode }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--urlquery-color);" target="_blank">
                                        View on URLQuery
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if result.type == "IP" and "SANS" in selected_tools and result.data.sans %}
                        {% set is_safe = is_module_result_safe(result.data.sans, 'sans') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="sans" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--sans-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-fire mr-2"></i>SANS</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.sans.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.sans.error }}</small>
                                    </div>
                                    {% elif result.data.sans.found %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-warning">Found in Intel Feed</span></small>
                                    </p>
                                    {% if result.data.sans.threatfeeds and result.data.sans.threatfeeds|length > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Found in Feeds:</strong> 
                                            {% for feed in result.data.sans.threatfeeds %}
                                                <span class="badge badge-info mr-1">{{ feed }}</span>
                                            {% endfor %}
                                        </small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.attacks and result.data.sans.attacks > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Attacks:</strong> {{ result.data.sans.attacks }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.count and result.data.sans.count > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Reports:</strong> {{ result.data.sans.count }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.maxrisk and result.data.sans.maxrisk > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Max Risk:</strong> {{ result.data.sans.maxrisk }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.description %}
                                    <p class="mb-1">
                                        <small><strong>Description:</strong> {{ result.data.sans.description }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.asname %}
                                    <p class="mb-1">
                                        <small><strong>AS:</strong> {{ result.data.sans.as }} - {{ result.data.sans.asname }} ({{ result.data.sans.ascountry }})</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.network %}
                                    <p class="mb-1">
                                        <small><strong>Network:</strong> {{ result.data.sans.network }}</small>
                                    </p>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not Found in Threat Feeds</span></small>
                                    </p>
                                    {% if result.data.sans.description %}
                                    <p class="mb-1">
                                        <small>{{ result.data.sans.description }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.sans.asname %}
                                    <p class="mb-1">
                                        <small><strong>AS:</strong> {{ result.data.sans.as }} - {{ result.data.sans.asname }} ({{ result.data.sans.ascountry }})</small>
                                    </p>
                                    {% endif %}
                                    {% endif %}
                                    {% if result.data.sans.link %}
                                    <a href="{{ result.data.sans.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--sans-color);" target="_blank">
                                        View on SANS
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.data.resolved_ip or result.type == "IP" %}
                        {% if "IPInfo" in selected_tools %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100 ip-info-box">
                                <div class="card-header py-1">
                                    <h6 class="mb-0"><i class="fas fa-map-marker-alt mr-2"></i>IPinfo</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% set ipinfo_data = result.data.ipinfo if result.data.ipinfo else {} %}
                                    {% if ipinfo_data.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>Error retrieving IP information: {{ ipinfo_data.error }}</small>
                                    </div>
                                    {% elif ipinfo_data %}
                                    <div class="row">
                                        <div class="col-6">
                                            {% if result.data.resolved_ip %}
                                            <p class="mb-1"><small><strong>Resolved IP:</strong> {{ result.data.resolved_ip }}</small></p>
                                            {% endif %}
                                            {% if ipinfo_data.ip %}
                                            <p class="mb-1"><small><strong>IP:</strong> {{ ipinfo_data.ip }}</small></p>
                                            {% endif %}
                                            {% if ipinfo_data.hostname %}
                                            <p class="mb-1"><small><strong>Host:</strong> {{ ipinfo_data.hostname }}</small></p>
                                            {% endif %}
                                            {% if ipinfo_data.city %}
                                            <p class="mb-1"><small><strong>Location:</strong> {{ ipinfo_data.city }}{% if ipinfo_data.region %}, {{ ipinfo_data.region }}{% endif %}</small></p>
                                            {% endif %}
                                        </div>
                                        <div class="col-6">
                                            {% if ipinfo_data.country %}
                                            <p class="mb-1"><small><strong>Country:</strong> {{ ipinfo_data.country }}</small></p>
                                            {% endif %}
                                            {% if ipinfo_data.org %}
                                            <p class="mb-1"><small><strong>Org:</strong> {{ ipinfo_data.org }}</small></p>
                                            {% endif %}
                                            {% if ipinfo_data.timezone %}
                                            <p class="mb-1"><small><strong>TZ:</strong> {{ ipinfo_data.timezone }}</small></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if ipinfo_data.loc and ipinfo_data.loc.split(',')|length >= 2 %}
                                    {% set loc_parts = ipinfo_data.loc.split(',') %}
                                    {% if loc_parts[0] and loc_parts[1] %}
                                    <div class="mt-1">
                                        <div class="map-container" style="height: 120px; width: 100%;">
                                            <iframe
                                                width="100%"
                                                height="100%"
                                                frameborder="0"
                                                scrolling="no"
                                                marginheight="0"
                                                marginwidth="0"
                                                src="https://www.openstreetmap.org/export/embed.html?bbox={{ loc_parts[1]|float - 0.1 }},{{ loc_parts[0]|float - 0.1 }},{{ loc_parts[1]|float + 0.1 }},{{ loc_parts[0]|float + 0.1 }}&amp;layer=mapnik&amp;marker={{ loc_parts[0] }},{{ loc_parts[1] }}"
                                                style="border: 1px solid black">
                                            </iframe>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    {% else %}
                                    <div class="alert alert-info py-1 mb-1">
                                        <small>No IP information available</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if result.type == "Domain" and result.data.crtsh %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100 crtsh-box">
                                <div class="card-header py-1">
                                    <h6 class="mb-0"><i class="fas fa-certificate mr-2"></i>CRT.sh</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.crtsh.certificates %}
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Total:</strong> {{ result.data.crtsh.total_certificates }}</small></p>
                                            <p class="mb-1"><small><strong>Unique:</strong> {{ result.data.crtsh.total_unique_domains }}</small></p>
                                        </div>
                                        <div class="col-6">
                                            <a href="https://crt.sh/?q={{ result.value }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--crtsh-color);" target="_blank">
                                                View on crt.sh
                                            </a>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                    </div>
                                    <div class="table-responsive scrollable-card-container">
                                        <table class="table table-sm mb-0 ssl-table">
                                            <thead>
                                                <tr>
                                                    <th><small>Logged At</small></th>
                                                    <th><small>Domain</small></th>
                                                    <th><small>Issuer</small></th>
                                                    <th><small>Valid Until</small></th>
                                                    <th><small>Status</small></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set seen_domains = [] %}
                                                {% set sorted_certs = result.data.crtsh.certificates|sort(attribute='logged_at', reverse=true)|list %}
                                                {% for cert in sorted_certs %}
                                                    {% if cert.common_name not in seen_domains %}
                                                        {% set _ = seen_domains.append(cert.common_name) %}
                                                        <tr>
                                                            <td><small>{{ cert.logged_at }}</small></td>
                                                            <td><small>{{ cert.common_name }}</small></td>
                                                            <td><small>{{ cert.issuer_name }}</small></td>
                                                            <td><small>{{ cert.not_after }}</small></td>
                                                            <td><small>{{ cert.status }}</small></td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="mb-0"><small>No certificates found</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

{% if result.type == "IP" and "ReverseDNS" in selected_tools and result.data.reversedns and (result.data.reversedns.hostname or (result.data.reversedns.aliases and result.data.reversedns.aliases|length > 0)) %}
                        {% set is_safe = is_module_result_safe(result.data.reversedns, 'reversedns') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100 reversedns-box" data-tool="reversedns" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1">
                                    <h6 class="mb-0"><i class="fas fa-exchange-alt mr-2"></i>Reverse DNS</h6>
                                </div>
                                <div class="card-body p-2">
                                    <p class="mb-1"><small><strong>Hostname:</strong> {{ result.data.reversedns.hostname }}</small></p>
                                    {% if result.data.reversedns.aliases %}
                                    <p class="mb-1"><small><strong>Aliases:</strong></small></p>
                                    <ul class="list-unstyled mb-0">
                                        {% for alias in result.data.reversedns.aliases %}
                                        <li><small>{{ alias }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if result.data.reversedns.link %}
                                    <a href="{{ result.data.reversedns.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--reversedns-color);" target="_blank">Details</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if "URLHaus" in selected_tools and result.data.urlhaus %}
                        {% set is_safe = is_module_result_safe(result.data.urlhaus, 'urlhaus') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="urlhaus" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--urlhaus-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>URLHaus</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.urlhaus.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.urlhaus.error }}</small>
                                    </div>
                                    {% else %}
                                    <p class="mb-1"><small><strong>Status:</strong> {{ result.data.urlhaus.status or 'Unknown' }}</small></p>
                                    <p class="mb-1"><small><strong>Threat:</strong> {{ result.data.urlhaus.threat or 'Unknown' }}</small></p>
                                    <p class="mb-1"><small><strong>Date Added:</strong> {{ result.data.urlhaus.date_added or 'Unknown' }}</small></p>
                                    {% if result.data.urlhaus.signature %}
                                    <p class="mb-1"><small><strong>Signature:</strong> {{ result.data.urlhaus.signature }}</small></p>
                                    {% endif %}
                                    {% if result.data.urlhaus.reporter %}
                                    <p class="mb-1"><small><strong>Reporter:</strong> {{ result.data.urlhaus.reporter }}</small></p>
                                    {% endif %}
                                    {% if result.data.urlhaus.tags %}
                                    <p class="mb-1"><small><strong>Tags:</strong> {{ result.data.urlhaus.tags | join(', ') }}</small></p>
                                    {% endif %}
                                    {% if result.data.urlhaus.blacklists %}
                                    <p class="mb-1"><small><strong>Blacklists:</strong></small></p>
                                    <ul class="mb-1 pl-3">
                                        {% for entry in result.data.urlhaus.blacklists %}
                                        <li><small>{{ entry }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if result.data.urlhaus.link %}
                                    <a href="{{ result.data.urlhaus.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--urlhaus-color);" target="_blank">View on URLHaus</a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if "ThreatFox" in selected_tools and result.data.threatfox %}
                        {% set is_safe = is_module_result_safe(result.data.threatfox, 'threatfox') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="threatfox" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--threatfox-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-shield-alt mr-2"></i>ThreatFox</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.threatfox.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.threatfox.error }}</small>
                                    </div>
                                    {% else %}
                                    <p class="mb-1"><small><strong>Status:</strong> {{ result.data.threatfox.status or 'Unknown' }}</small></p>
                                    <p class="mb-1"><small><strong>IOC Type:</strong> {{ result.data.threatfox.ioc_type or 'Unknown' }}</small></p>
                                    {% if result.data.threatfox.total_results %}
                                    <p class="mb-1"><small><strong>Total Results:</strong> {{ result.data.threatfox.total_results }}</small></p>
                                    {% endif %}
                                    {% if result.data.threatfox.results %}
                                    {% for entry in result.data.threatfox.results %}
                                    <div class="border-top pt-1 mt-1">
                                        <p class="mb-1"><small><strong>Threat Type:</strong> {{ entry.threat_type or 'Unknown' }}</small></p>
                                        <p class="mb-1"><small><strong>Malware:</strong> {{ entry.malware_printable or entry.malware or 'Unknown' }}</small></p>
                                        {% if entry.malware_alias %}
                                        <p class="mb-1"><small><strong>Aliases:</strong> {{ entry.malware_alias | join(', ') }}</small></p>
                                        {% endif %}
                                        <p class="mb-1"><small><strong>First Seen:</strong> {{ entry.first_seen or 'Unknown' }}</small></p>
                                        <p class="mb-1"><small><strong>Last Seen:</strong> {{ entry.last_seen or 'Unknown' }}</small></p>
                                        <p class="mb-1"><small><strong>Confidence:</strong> {{ entry.confidence_level or 0 }}%</small></p>
                                        {% if entry.tags %}
                                        <p class="mb-1"><small><strong>Tags:</strong> {{ entry.tags | join(', ') }}</small></p>
                                        {% endif %}
                                        {% if entry.reporter %}
                                        <p class="mb-1"><small><strong>Reporter:</strong> {{ entry.reporter }}</small></p>
                                        {% endif %}
                                        {% if entry.link %}
                                        <a href="{{ entry.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--threatfox-color);" target="_blank">View on ThreatFox</a>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if "VirusTotal" in selected_tools and result.data.virustotal %}
                        {% set is_safe = is_module_result_safe(result.data.virustotal, 'virustotal') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100 virustotal-box" data-tool="virustotal" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1">
                                    <h6 class="mb-0"><i class="fas fa-virus mr-2"></i>VirusTotal</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.virustotal.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.virustotal.error }}</small>
                                    </div>
                                    {% else %}
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Risk Score:</strong> 
                                                <span class="risk-score 
                                                    {% if result.data.virustotal.get('risk_score') and result.data.virustotal.get('risk_score') >= 70 %}risk-high
                                                    {% elif result.data.virustotal.get('risk_score') and result.data.virustotal.get('risk_score') >= 30 %}risk-medium
                                                    {% else %}risk-low{% endif %}">
                                                    {{ result.data.virustotal.get('risk_score', 'N/A') }}%
                                                </span>
                                            </small></p>
                                            <p class="mb-1"><small><strong>Last Analysis:</strong> {{ result.data.virustotal.last_analysis_date }}</small></p>
                                            <p class="mb-1"><small><strong>Detection Ratio:</strong> {{ result.data.virustotal.detection_ratio }}</small></p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Total Engines:</strong> {{ result.data.virustotal.total_engines }}</small></p>
                                            <p class="mb-1"><small><strong>Malicious Engines:</strong> {{ result.data.virustotal.malicious_engines }}</small></p>
                                            {% if result.data.virustotal.link %}
                                            <a href="{{ result.data.virustotal.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--virustotal-color);" target="_blank">View on VirusTotal</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if result.data.virustotal.analysis_results %}
                                    <div class="mt-2">
                                        <p class="mb-1"><small><strong>Analysis Results:</strong></small></p>
                                        <div class="table-responsive scrollable-card-container">
                                            <div class="scrollable-card-search mb-2">
                                                <input type="text" class="form-control form-control-sm card-search-input" placeholder="Search in this table..." data-table-target="">
                                            </div>
                                            <table class="table table-sm mb-0">
                                                <thead>
                                                    <tr>
                                                        <th><small>Engine</small></th>
                                                        <th><small>Result</small></th>
                                                        <th><small>Category</small></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for engine, details in result.data.virustotal.analysis_results.items() %}
                                                    <tr>
                                                        <td><small>{{ engine }}</small></td>
                                                        <td><small>{{ details.result }}</small></td>
                                                        <td><small>{{ details.category }}</small></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if result.data.virustotal.additional_info %}
                                    <div class="mt-2">
                                        <p class="mb-1"><small><strong>Additional Information:</strong></small></p>
                                        <div class="table-responsive scrollable-card-container">
                                            <div class="scrollable-card-search mb-2">
                                                <input type="text" class="form-control form-control-sm card-search-input" placeholder="Search in this table..." data-table-target="">
                                            </div>
                                            <table class="table table-sm mb-0">
                                                <tbody>
                                                    {% for key, value in result.data.virustotal.additional_info.items() %}
                                                    <tr>
                                                        <td><small><strong>{{ key }}:</strong></small></td>
                                                        <td><small>{{ value }}</small></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.type == "Hash" and "MalwareBazaar" in selected_tools %}
                        {% if result.data.malwarebazaar %}
                        {% set is_safe = is_module_result_safe(result.data.malwarebazaar, 'malwarebazaar') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="malwarebazaar" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--malwarebazaar-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-bug mr-2"></i>MalwareBazaar</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.malwarebazaar.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.malwarebazaar.error }}</small>
                                    </div>
                                    {% elif result.data.malwarebazaar.found %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            <span class="badge badge-danger">Malware Detected</span>
                                        </small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>File Name:</strong> {{ result.data.malwarebazaar.file_name }}</small>
                                    </p>
                                    <p class="mb-1">
                                        <small><strong>File Type:</strong> {{ result.data.malwarebazaar.file_type }}</small>
                                    </p>
                                    {% if result.data.malwarebazaar.signature and result.data.malwarebazaar.signature != "Unknown" %}
                                    <p class="mb-1">
                                        <small><strong>Signature:</strong> {{ result.data.malwarebazaar.signature }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.malwarebazaar.tags and result.data.malwarebazaar.tags|length > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Tags:</strong> 
                                            {% for tag in result.data.malwarebazaar.tags %}
                                                <span class="badge badge-secondary">{{ tag }}</span>
                                            {% endfor %}
                                        </small>
                                    </p>
                                    {% endif %}
                                    <p class="mb-1">
                                        <small><strong>First Seen:</strong> {{ result.data.malwarebazaar.first_seen }}</small>
                                    </p>
                                    {% if result.data.malwarebazaar.link %}
                                    <a href="{{ result.data.malwarebazaar.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--malwarebazaar-color);" target="_blank">
                                        View on MalwareBazaar
                                    </a>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not Found</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.malwarebazaar.status }}</small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {# Hybrid Analysis supports Hash, Domain, IP. Do not render on URL #}
                        {% if (result.type == "Hash" or result.type == "Domain" or result.type == "IP") and "HybridAnalysis" in selected_tools %}
                        {% if result.data.hybridanalysis %}
                        {% set is_safe = is_module_result_safe(result.data.hybridanalysis, 'hybridanalysis') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="hybridanalysis" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--hybridanalysis-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-vial mr-2"></i>Hybrid Analysis</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.hybridanalysis.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.hybridanalysis.error }}</small>
                                    </div>
                                    {% if result.data.hybridanalysis.link %}
                                    <a href="{{ result.data.hybridanalysis.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--hybridanalysis-color);" target="_blank">
                                        View on Hybrid Analysis
                                    </a>
                                    {% endif %}
                                    {% elif result.data.hybridanalysis.found %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> 
                                            <span class="badge badge-danger">Listed</span>
                                        </small>
                                    </p>
                                    {% if result.data.hybridanalysis.verdict %}
                                    <p class="mb-1">
                                        <small><strong>Verdict:</strong> {{ result.data.hybridanalysis.verdict }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.threat_score is defined %}
                                    <p class="mb-1">
                                        <small><strong>Threat Score:</strong> {{ result.data.hybridanalysis.threat_score }}/100</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.av_detect is defined %}
                                    <p class="mb-1">
                                        <small><strong>AV Detection:</strong> {{ result.data.hybridanalysis.av_detect }}%</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.malware_family and result.data.hybridanalysis.malware_family|length > 0 %}
                                    <p class="mb-1">
                                        <small><strong>Malware Family:</strong> 
                                            {% for family in result.data.hybridanalysis.malware_family %}
                                                <span class="badge badge-secondary">{{ family }}</span>
                                            {% endfor %}
                                        </small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.submit_name %}
                                    <p class="mb-1">
                                        <small><strong>File:</strong> {{ result.data.hybridanalysis.submit_name }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.sha256 and result.data.hybridanalysis.sha256 != "Unknown" %}
                                    <p class="mb-1">
                                        <small><strong>SHA256:</strong> <code style="font-size: 0.85em;">{{ result.data.hybridanalysis.sha256[:32] }}...</code></small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.count %}
                                    <p class="mb-1">
                                        <small><strong>Total Samples:</strong> {{ result.data.hybridanalysis.count }}</small>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.raw_data %}
                                    <p class="mb-1">
                                        <small><strong>Response Data:</strong></small>
                                        <pre style="font-size: 0.7em; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 3px; margin-top: 5px;">{{ result.data.hybridanalysis.raw_data }}</pre>
                                    </p>
                                    {% endif %}
                                    {% if result.data.hybridanalysis.link %}
                                    <a href="{{ result.data.hybridanalysis.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--hybridanalysis-color);" target="_blank">
                                        View on Hybrid Analysis
                                    </a>
                                    {% elif result.data.hybridanalysis.sha256 and result.data.hybridanalysis.sha256 != "Unknown" %}
                                    <a href="https://www.hybrid-analysis.com/sample/{{ result.data.hybridanalysis.sha256 }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--hybridanalysis-color);" target="_blank">
                                        View on Hybrid Analysis
                                    </a>
                                    {% endif %}
                                    {% else %}
                                    <p class="mb-1">
                                        <small><strong>Status:</strong> <span class="badge badge-success">Not Found</span></small>
                                    </p>
                                    <p class="mb-1">
                                        <small>{{ result.data.hybridanalysis.status }}</small>
                                    </p>
                                    {% if result.data.hybridanalysis.link %}
                                    <a href="{{ result.data.hybridanalysis.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--hybridanalysis-color);" target="_blank">
                                        View on Hybrid Analysis
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}


                        {% if result.type == "URL" or result.type == "Domain" %}
                            {% if "URLScanSearch" in selected_tools and result.data.urlscan_search and result.data.urlscan_search.scan_history and result.data.urlscan_search.scan_history|length > 0 %}
                            <div class="col-md-6 col-lg-6 mb-2">
                                <div class="card h-100 urlscan-box">
                                    <div class="card-header py-1" style="background-color: var(--urlscan-search-color) !important; color: white;">
                                        <h6 class="mb-0"><i class="fas fa-search mr-2"></i>URLScan Search Results ({{ result.data.urlscan_search.scan_history|length }})</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        {% if result.data.urlscan_search.error %}
                                        <div class="alert alert-warning py-1 mb-1">
                                            <small>{{ result.data.urlscan_search.error }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="table-responsive scrollable-card-container">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th><small>Scan Date</small></th>
                                                        <th><small>URL</small></th>
                                                        <th class="text-center"><small>Screenshot</small></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for scan in result.data.urlscan_search.scan_history %}
                                                    <tr>
                                                        <td><small>{{ scan.scan_date }}</small></td>
                                                        <td>
                                                            <small>
                                                                <a href="{{ scan.report_url }}" target="_blank" title="{{ scan.url }}">
                                                                    {{ scan.url|truncate(50) }}
                                                                </a>
                                                            </small>
                                                        </td>
                                                        <td class="text-center">
                                                            {% if scan.screenshot_url %}
                                                            <span class="screenshot-preview">
                                                                <i class="fas fa-camera" title="View Screenshot"></i>
                                                                <div class="preview-image">
                                                                    <img src="{{ scan.screenshot_url }}" alt="Screenshot">
                                                                </div>
                                                            </span>
                                                            {% else %}
                                                            <small>-</small>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        {% if result.data.urlscan_search.report_url %}
                                        <div class="mt-3">
                                            <a href="{{ result.data.urlscan_search.report_url }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--url-color);" target="_blank">View All Results on URLScan</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if "URLScanScan" in selected_tools and result.data.urlscan_scan %}
                            <div class="col-md-6 col-lg-6 mb-2">
                                <div class="card h-100 urlscan-box">
                                    <div class="card-header py-1" style="background-color: var(--urlscan-scan-color) !important; color: white;">
                                        <h6 class="mb-0"><i class="fas fa-camera mr-2"></i>URLScan Scan Results</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        {% if result.data.urlscan_scan.error %}
                                        <div class="alert alert-warning py-1 mb-1">
                                            <small>{{ result.data.urlscan_scan.error }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        {% if result.data.urlscan_scan.message %}
                                        <div class="alert alert-info py-1 mb-1">
                                            <small>{{ result.data.urlscan_scan.message }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        {% if result.data.urlscan_scan.scan_id %}
                                        <div class="row">
                                            <div class="col-12">
                                                <p class="mb-1"><small><strong>Scan ID:</strong> {{ result.data.urlscan_scan.scan_id }}</small></p>
                                                {% if result.data.urlscan_scan.result_url %}
                                                <a href="{{ result.data.urlscan_scan.result_url }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--url-color);" target="_blank">View Scan Results</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}

                        {% if "OpenCTI" in selected_tools and result.data.opencti %}
                        {% set is_safe = is_module_result_safe(result.data.opencti, 'opencti') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="opencti" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--opencti-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-project-diagram mr-2"></i>OpenCTI</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.opencti.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.opencti.error }}</small>
                                    </div>
                                    {% elif result.data.opencti.results and result.data.opencti.results|length > 0 %}
                                        <p class="mb-1"><small><strong>Found:</strong> {{ result.data.opencti.total }} result(s)</small></p>
                                        <div class="table-responsive scrollable-card-container">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th><small>Created</small></th>
                                                        <th><small>Entity</small></th>
                                                        <th><small>Type</small></th>
                                                        <th><small>Labels</small></th>
                                                        <th><small>Score</small></th>
                                                        <th class="text-center"><small>Link</small></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in result.data.opencti.results %}
                                                    <tr>
                                                        <td><small>{{ item.created_at.split('T')[0] if item.created_at else 'N/A' }}</small></td>
                                                        <td><small>
                                                            {% if item.observable_value %}
                                                                {{ item.observable_value }}
                                                            {% elif item.pattern %}
                                                                {{ item.pattern }}
                                                            {% elif item.name %}
                                                                {{ item.name }}
                                                            {% else %}
                                                                {{ result.data.opencti.observable }}
                                                            {% endif %}
                                                        </small></td>
                                                        <td><small>{{ item.entity_type or item.observable_type or 'Unknown' }}</small></td>
                                                        <td><small>
                                                            {% if item.labels and item.labels|length > 0 %}
                                                                {% for label in item.labels %}
                                                                    <span class="badge badge-secondary mr-1">{{ label }}</span>
                                                                {% endfor %}
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </small></td>
                                                        <td><small>{{ item.score or 'N/A' }}</small></td>
                                                        <td class="text-center">
                                                            {% if item.id and OPENCTI_URL %}
                                                            <a href="{{ OPENCTI_URL }}/dashboard/observations/{{ (item.entity_type|lower) if item.entity_type else (item.observable_type|lower if item.observable_type else 'indicator') }}/{{ item.id }}" 
                                                               class="btn btn-sm py-0 text-white" 
                                                               style="background-color: var(--loading-color);" 
                                                               target="_blank">
                                                                <i class="fas fa-external-link-alt"></i>
                                                            </a>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p class="mb-0"><small>No results found in OpenCTI for {{ result.data.opencti.observable }}.</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

{% if result.type == "IP" and "ShodanInternetDB" in selected_tools and result.data.shodan_internetdb and ((result.data.shodan_internetdb.hostnames and result.data.shodan_internetdb.hostnames|length > 0) or (result.data.shodan_internetdb.ports and result.data.shodan_internetdb.ports|length > 0) or (result.data.shodan_internetdb.vulns and result.data.shodan_internetdb.vulns|length > 0)) %}
                        {% set is_safe = is_module_result_safe(result.data.shodan_internetdb, 'shodan_internetdb') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="shodan_internetdb" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--shodan-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-database mr-2"></i>Shodan InternetDB</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.shodan_internetdb.hostnames %}
                                    <p class="mb-1"><small><strong>Hostnames:</strong></small></p>
                                    <ul class="list-unstyled mb-0">
                                        {% for hostname in result.data.shodan_internetdb.hostnames %}
                                        <li><small>{{ hostname }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if result.data.shodan_internetdb.ports %}
                                    <p class="mb-1"><small><strong>Open Ports:</strong></small></p>
                                    <ul class="list-unstyled mb-0">
                                        {% for port in result.data.shodan_internetdb.ports %}
                                        <li><small>{{ port }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if result.data.shodan_internetdb.vulns %}
                                    <p class="mb-1"><small><strong>Vulnerabilities:</strong></small></p>
                                    <ul class="list-unstyled mb-0">
                                        {% for vuln in result.data.shodan_internetdb.vulns %}
                                        <li><small>{{ vuln }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

{% if result.type == "Domain" and "WHOIS" in selected_tools and result.data.rdap and (result.data.rdap.creation_date or result.data.rdap.expiration_date or result.data.rdap.registrar or (result.data.rdap.name_servers and result.data.rdap.name_servers|length > 0) or result.data.rdap.all_emails or result.data.rdap.registrant or result.data.rdap.link) %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100 whois-box">
                                <div class="card-header py-1" style="background-color: var(--whois-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-globe mr-2"></i>WHOIS Information</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.rdap and result.data.rdap.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>Error retrieving WHOIS information: {{ result.data.rdap.error }}</small>
                                    </div>
                                    {% elif result.data.rdap %}
                                    <div class="row">
                                        <div class="col-6">
                                            {% if result.data.rdap.creation_date %}
                                            <p class="mb-1"><small><strong>Created:</strong> {{ result.data.rdap.creation_date }}
                                                {% set creation_date = datetime.strptime(result.data.rdap.creation_date, '%Y-%m-%d') %}
                                                {% set days_old = (now().date() - creation_date.date()).days %}
                                                {% if days_old < 30 %}
                                                <span class="badge badge-danger ml-2" title="Domain registered less than 30 days ago">
                                                    <i class="fas fa-exclamation-triangle"></i> New Domain
                                                </span>
                                                {% endif %}
                                            </small></p>
                                            {% endif %}
                                            {% if result.data.rdap.expiration_date %}
                                            <p class="mb-1"><small><strong>Expires:</strong> {{ result.data.rdap.expiration_date }}</small></p>
                                            {% endif %}
                                            {% if result.data.rdap.registrar %}
                                            <p class="mb-1"><small><strong>Registrar:</strong> {{ result.data.rdap.registrar }}</small></p>
                                            {% endif %}
                                            {% set all_emails = [] %}
                                            {# Handle all_emails which can be a string or list #}
                                            {% if result.data.rdap.all_emails %}
                                                {% if result.data.rdap.all_emails is string %}
                                                    {% set _ = all_emails.append(result.data.rdap.all_emails) %}
                                                {% else %}
                                                    {% for email in result.data.rdap.all_emails %}
                                                        {% if email %}
                                                            {% set _ = all_emails.append(email) %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            {% endif %}
                                            {# Add info@domain email if available #}
                                            {% if result.observable %}
                                                {% set info_email = 'info@' + result.observable %}
                                                {% set _ = all_emails.append(info_email) %}
                                            {% endif %}
                                            {% if all_emails %}
                                            <p class="mb-1"><small><strong>Email Addresses:</strong></small></p>
                                            <ul class="list-unstyled mb-1">
                                                {% set unique_emails = all_emails|unique %}
                                                {% for email in unique_emails %}
                                                <li><small>{{ email }}</small></li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if result.data.rdap.registrant and result.data.rdap.registrant != "REDACTED FOR PRIVACY" %}
                                            <p class="mb-1"><small><strong>Registrant:</strong> {{ result.data.rdap.registrant }}</small></p>
                                            {% endif %}
                                        </div>
                                        <div class="col-6">
                                            {% if result.data.rdap.name_servers %}
                                            <p class="mb-1"><small><strong>Name Servers:</strong></small></p>
                                            <ul class="list-unstyled mb-1">
                                                {% for ns in result.data.rdap.name_servers %}
                                                {% if ns and ns != "creation" and ns != "updated" %}
                                                <li><small>{{ ns }}</small></li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if result.data.rdap.link %}
                                            <a href="{{ result.data.rdap.link }}" class="btn btn-sm btn-block py-0 text-white" style="background-color: var(--whois-color);" target="_blank">Details</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.type == "Domain" and "DNSRecords" in selected_tools %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100">
                                <div class="card-header py-1" style="background-color: var(--dns-records-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-server mr-2"></i>DNS Records</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.dns_records %}
                                    {% if result.data.dns_records.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.dns_records.error }}</small>
                                    </div>
                                    {% else %}
                                    {% set records = result.data.dns_records %}
                                    
                                    {% if records.a_records and records.a_records|length > 0 %}
                                    <p class="mb-1"><small><strong>A Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.a_records %}
                                        <li><small>{{ record }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.aaaa_records %}
                                    <p class="mb-1"><small><strong>AAAA Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.aaaa_records %}
                                        <li><small>{{ record }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.mx_records %}
                                    <p class="mb-1"><small><strong>MX Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.mx_records %}
                                        <li><small>Priority: {{ record.preference }} - {{ record.exchange }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.txt_records %}
                                    <p class="mb-1"><small><strong>TXT Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.txt_records %}
                                        <li><small>{{ record }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.ns_records %}
                                    <p class="mb-1"><small><strong>NS Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.ns_records %}
                                        <li><small>{{ record }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.soa_records %}
                                    <p class="mb-1"><small><strong>SOA Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.soa_records %}
                                        <li><small>
                                            MNAME: {{ record.mname }}<br>
                                            RNAME: {{ record.rname }}<br>
                                            Serial: {{ record.serial }}<br>
                                            Refresh: {{ record.refresh }}<br>
                                            Retry: {{ record.retry }}<br>
                                            Expire: {{ record.expire }}<br>
                                            Minimum: {{ record.minimum }}
                                        </small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}

                                    {% if records.spf_records %}
                                    <p class="mb-1"><small><strong>SPF Records:</strong></small></p>
                                    <ul class="list-unstyled mb-1">
                                        {% for record in records.spf_records %}
                                        <li><small>{{ record }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    
                                    {% if not records.a_records and not records.aaaa_records and not records.mx_records and not records.txt_records and not records.ns_records and not records.cname_records %}
                                    <p class="mb-1"><small>No DNS records found</small></p>
                                    {% endif %}
                                    {% endif %}
                                    {% else %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>DNS records not available</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.type == "Domain" and "WaybackMachine" in selected_tools and result.data.wayback_machine %}
                        {% set is_safe = is_module_result_safe(result.data.wayback_machine, 'wayback_machine') %}
                        <div class="col-md-4 col-lg-3 mb-2">
                            <div class="card h-100" data-tool="wayback_machine" data-is-safe="{{ 'true' if is_safe else 'false' }}">
                                <div class="card-header py-1" style="background-color: var(--waybackmachine-color) !important; color: white;">
                                    <h6 class="mb-0"><i class="fas fa-history mr-2"></i>Wayback Machine</h6>
                                </div>
                                <div class="card-body p-2">
                                    {% if result.data.wayback_machine.error %}
                                    <div class="alert alert-warning py-1 mb-1">
                                        <small>{{ result.data.wayback_machine.error }}</small>
                                    </div>
                                    {% else %}
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><small><strong>Total Snapshots:</strong> {{ result.data.wayback_machine.total_snapshots }}</small></p>
                                            {% if result.data.wayback_machine.first_snapshot %}
                                            <p class="mb-1"><small><strong>First Snapshot:</strong> {{ result.data.wayback_machine.first_snapshot }}</small></p>
                                            {% endif %}
                                        </div>
                                        <div class="col-6">
                                            {% if result.data.wayback_machine.last_snapshot %}
                                            <p class="mb-1"><small><strong>Last Snapshot:</strong> {{ result.data.wayback_machine.last_snapshot }}</small></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if result.data.wayback_machine.snapshots %}
                                    <div class="mt-2">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th><small>Date</small></th>
                                                        <th><small>URL</small></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for snapshot in result.data.wayback_machine.snapshots %}
                                                    <tr>
                                                        <td><small>{{ snapshot.date or snapshot.timestamp or '-' }}</small></td>
                                                        <td>
                                                            <small>
                                                                {% if snapshot.url or snapshot.archive_url %}
                                                                <a href="{{ snapshot.url or snapshot.archive_url }}" target="_blank" title="{{ snapshot.original_url or snapshot.url or '-' }}">
                                                                    {{ (snapshot.original_url or snapshot.url or '-')|truncate(50) }}
                                                                </a>
                                                                {% else %}
                                                                {{ snapshot.original_url or snapshot.url or '-' }}
                                                                {% endif %}
                                                            </small>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">Total snapshots: {{ result.data.wayback_machine.total_snapshots }}</small>
                                            <a href="https://web.archive.org/web/*/{{ result.observable }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-external-link-alt"></i> View All on Wayback Machine
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            </div>
            
            <!-- Table View (secondary option) -->
            <div class="tab-pane fade" id="tableView" role="tabpanel" aria-labelledby="table-tab">
                {% if df and df != "<p>Loading results...</p>" %}
                    {{ df|safe }}
                {% else %}
                    <div class="alert alert-info">Geen tabel data beschikbaar. Gebruik de Cards weergave of wacht tot de resultaten zijn geladen.</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade screenshot-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Screenshot Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img src="" alt="Screenshot">
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script>
    // Initialize global variables
    // Load API status from localStorage if available, otherwise use server-provided status
    let API_STATUS = {};
    const savedApiStatus = localStorage.getItem('apiStatus');
    if (savedApiStatus) {
        try {
            API_STATUS = JSON.parse(savedApiStatus);
            // Merge with server status to get any new keys
            const serverStatus = {{ api_status|tojson|safe }};
            API_STATUS = Object.assign({}, serverStatus, API_STATUS);
        } catch (e) {
            console.error('Error loading saved API status:', e);
            API_STATUS = {{ api_status|tojson|safe }};
        }
    } else {
        API_STATUS = {{ api_status|tojson|safe }};
    }
    const RESULTS = {{ results|tojson|safe if results else '[]' }};
    
    // Ensure checkApiStatus exists (defined later); fallback no-op to avoid reference errors
    if (typeof window.checkApiStatus !== 'function') {
        window.checkApiStatus = function() { return API_STATUS; };
    }
    
        // Function to update API status in UI
        function updateApiStatusInUI(newStatus) {
            // Update the global API_STATUS variable
            API_STATUS = Object.assign({}, newStatus);
            
            // Save to localStorage to persist across page loads
            localStorage.setItem('apiStatus', JSON.stringify(API_STATUS));
            
            // Update each checkbox and status indicator using data-api-key attribute
            $('.form-check[data-api-key]').each(function() {
                const $formCheck = $(this);
                const apiKeyName = $formCheck.attr('data-api-key');
                const $checkbox = $formCheck.find('input[type="checkbox"]');
                const $label = $formCheck.find('label');
                const $statusIndicator = $label.find('.api-status');
                
                if (apiKeyName && newStatus[apiKeyName]) {
                    const status = newStatus[apiKeyName];
                    
                    $statusIndicator.removeClass('valid invalid unknown optional');
                    
                    if (status === 'valid') {
                        $statusIndicator.addClass('valid');
                        $statusIndicator.attr('title', 'API Key Valid');
                        $checkbox.prop('disabled', false);
                        $label.removeClass('text-muted');
                    } else if (status === 'invalid') {
                        $statusIndicator.addClass('invalid');
                        $statusIndicator.attr('title', 'API Key Invalid');
                        $checkbox.prop('disabled', true);
                        $checkbox.prop('checked', false); // Uncheck when API is invalid
                        $label.addClass('text-muted');
                    } else {
                        // Unknown status - orange and enabled
                        $statusIndicator.addClass('unknown');
                        $statusIndicator.attr('title', 'API Key Status Unknown');
                        $checkbox.prop('disabled', false);
                        $label.removeClass('text-muted');
                    }
                }
            });
            
            // Also update checkboxes based on API status (only disable invalid, not unknown)
            if (typeof checkApiStatus === 'function') {
                checkApiStatus();
            } else {
                console.warn('checkApiStatus not defined when updateApiStatusInUI ran');
            }
        }
    
    // Initialize UI with saved API status on page load
    $(document).ready(function() {
        if (Object.keys(API_STATUS).length > 0) {
            updateApiStatusInUI(API_STATUS);
        }
        
        // API keys are not auto-checked on page load - user must click "Check API Keys" button
    });
    
    // Handle Check API Keys button click
    $('#checkApiKeysBtn').on('click', async function() {
        const $btn = $(this);
        const originalText = $btn.html();
        
        // Disable button and show loading
        $btn.prop('disabled', true);
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Checking...');
        
        try {
            const response = await fetch('/check-api-keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update API status in UI
                updateApiStatusInUI(data.api_status);
                
                // Show success message
                $btn.html('<i class="fas fa-check"></i> Done');
                $btn.removeClass('btn-outline-info').addClass('btn-success');
                
                setTimeout(() => {
                    $btn.html(originalText);
                    $btn.removeClass('btn-success').addClass('btn-outline-info');
                    $btn.prop('disabled', false);
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to check API keys');
            }
        } catch (error) {
            console.error('Error checking API keys:', error);
            $btn.html('<i class="fas fa-exclamation-triangle"></i> Error');
            $btn.removeClass('btn-outline-info').addClass('btn-danger');
            
            setTimeout(() => {
                $btn.html(originalText);
                $btn.removeClass('btn-danger').addClass('btn-outline-info');
                $btn.prop('disabled', false);
            }, 3000);
        }
    });

    // Helpers to manage observable card order
    function getNextCardOrder() {
        const streamingResults = $('#streaming-results');
        let maxOrder = 0;
        streamingResults.find('.observable-card').each(function() {
            const val = parseInt($(this).attr('data-order'), 10);
            if (!isNaN(val) && val > maxOrder) {
                maxOrder = val;
            }
        });
        return maxOrder + 1;
    }

    function getObservableKey(card) {
        const obs = card.find('.observable-header').first().text().trim();
        const typ = card.find('.observable-type').first().text().trim();
        return `${obs}::${typ}`;
    }

    function ensureCardOrder(card) {
        const streamingResults = $('#streaming-results');
        const orderMap = streamingResults.data('orderMap') || {};
        let order = card.attr('data-order');
        const key = getObservableKey(card);

        // Global canonical order
        window.observableOrder = window.observableOrder || [];
        const globalIdx = window.observableOrder.indexOf(key);

        if (!order) {
            if (orderMap[key]) {
                order = orderMap[key];
            } else if (globalIdx >= 0) {
                order = globalIdx + 1;
            } else {
                // assign new global order
                window.observableOrder.push(key);
                order = window.observableOrder.length;
            }
            card.attr('data-order', order);
        } else {
            // If order exists but not tracked, sync it
            if (orderMap[key] !== order) {
                orderMap[key] = order;
            }
            if (globalIdx === -1) {
                window.observableOrder.push(key);
            }
        }
        orderMap[key] = order;
        streamingResults.data('orderMap', orderMap);
        return order;
    }

    // Helpers for tool card ordering within an observable
    function getToolKey(toolCol) {
        const toolAttr = toolCol.attr('data-tool');
        if (toolAttr) return toolAttr;
        const headerText = toolCol.find('.card-header h6, .card-header h5').first().text().trim();
        return headerText || `tool-${Math.random()}`;
    }

    function applyToolOrder(existingCard, newCard) {
        const existingTools = existingCard.find('.tool-card-col');
        if (!existingTools.length) return;
        const orderMap = {};
        existingTools.each(function(idx) {
            const key = getToolKey($(this));
            orderMap[key] = idx;
        });

        const newTools = newCard.find('.tool-card-col');
        if (!newTools.length) return;

        // Sort new tools by existing order; unseen tools go last in original order
        const sorted = Array.from(newTools).sort((a, b) => {
            const ka = getToolKey($(a));
            const kb = getToolKey($(b));
            const oa = orderMap.hasOwnProperty(ka) ? orderMap[ka] : Number.MAX_SAFE_INTEGER;
            const ob = orderMap.hasOwnProperty(kb) ? orderMap[kb] : Number.MAX_SAFE_INTEGER;
            if (oa !== ob) return oa - ob;
            return 0;
        });

        // Re-append in sorted order
        newTools.detach();
        const parent = newCard.find('.tool-cards-row').first();
        if (parent.length) {
            sorted.forEach(el => parent.append(el));
        }
    }

    // Reorder observable cards in streaming-results by data-order to keep deterministic order
    function reorderObservableCards() {
        // Intentionally disabled. Cards stay where they were first placed so the
        // UI does not reshuffle while results stream in.
        return;
    }

    // Keep layout static; cards stay where first placed.
    function reorganizeCards() {
        return;
    }

    // Append a new observable card in arrival order (two columns per row), keeping first-arrival slot.
    function appendObservableCard(cardElement) {
        const streamingResults = $('#streaming-results');
        const key = getObservableKey(cardElement);
        let positions = streamingResults.data('positions') || {};

        // Assign slot on first sight; keep it forever
        let pos = positions[key];
        if (pos === undefined) {
            pos = streamingResults.find('.observable-card').length;
            positions[key] = pos;
            streamingResults.data('positions', positions);
        }

        const rowIndex = Math.floor(pos / 2);
        const posInRow = pos % 2;

        // Ensure the target row exists
        let targetRow = streamingResults.find('.row').eq(rowIndex);
        if (!targetRow.length) {
            targetRow = $('<div class="row" style="width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 20px; margin-top: 0;"></div>');
            streamingResults.append(targetRow);
        }

        // Wrap the card in a fixed half-width column
        const colWrapper = $('<div class="col-md-6" style="padding-left: 15px; padding-right: 15px; margin-bottom: 0;"></div>');
        colWrapper.append(cardElement);

        // Insert at the correct slot (left=0, right=1)
        const cols = targetRow.children('.col-md-6');
        if (cols.length > posInRow) {
            cols.eq(posInRow).before(colWrapper);
        } else {
            targetRow.append(colWrapper);
        }
    }

    // -------- Observable store buffering to keep order and tools consistent --------
    window.observableStore = window.observableStore || [];

    function resetObservableStore() {
        window.observableStore = [];
        const streamingResults = $('#streaming-results');
        if (streamingResults.length) {
            streamingResults.data('positions', {});
        }
    }

    function upsertObservableCardFromHtml(cardEl) {
        const key = getObservableKey(cardEl);
        if (!key) return;

        // Find or create entry
        let entry = window.observableStore.find(e => e.key === key);
        if (!entry) {
            entry = {
                key,
                pos: window.observableStore.length,
                baseHtml: cardEl[0].outerHTML,
                tools: {}
            };
            window.observableStore.push(entry);
        } else if (!entry.baseHtml) {
            entry.baseHtml = cardEl[0].outerHTML;
        }

        // Cache tool cards by key (support legacy cards without .tool-card-col wrapper)
        const toolCols = [];
        cardEl.find('.tool-card-col').each(function() { toolCols.push($(this)); });
        if (toolCols.length === 0) {
            // Fallback: any direct cards inside tool rows
            cardEl.find('.tool-cards-row .card').each(function() {
                const wrap = $('<div class="tool-card-col"></div>');
                wrap.append($(this).clone());
                toolCols.push(wrap);
            });
        }
        toolCols.forEach((col, idx) => {
            const key = getToolKey(col) || `tool-${Object.keys(entry.tools).length + idx}`;
            entry.tools[key] = col[0].outerHTML;
        });
    }

    function renderObservableStore() {
        const streamingResults = $('#streaming-results');
        if (!streamingResults.length) return;

        const rows = [];
        window.observableStore.forEach(entry => {
            const base = entry.baseHtml ? $(entry.baseHtml) : $('<div class="card observable-card"><div class="card-body"><div class="row tool-cards-row"></div></div></div>');
            let toolRow = base.find('.tool-cards-row');
            if (!toolRow.length) {
                const body = base.find('.card-body').first();
                toolRow = $('<div class="row tool-cards-row"></div>');
                body.append(toolRow);
            } else {
                toolRow.empty();
            }
            Object.values(entry.tools).forEach(html => {
                toolRow.append($(html));
            });
            const rowIndex = Math.floor(entry.pos / 2);
            if (!rows[rowIndex]) {
                rows[rowIndex] = $('<div class="row" style="width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 20px; margin-top: 0;"></div>');
            }
            const colWrapper = $('<div class="col-md-6" style="padding-left: 15px; padding-right: 15px; margin-bottom: 0;"></div>');
            colWrapper.append(base);
            rows[rowIndex].append(colWrapper);
        });

        streamingResults.empty();
        rows.forEach(r => streamingResults.append(r));
        applyToolCardsLayout();
        filterSafeResults();
    }

    // Function to get column class based on columns per row
    function getColumnClass(columnsPerRow) {
        switch(columnsPerRow) {
            case 1: return 'col-md-12';
            case 2: return 'col-md-6';
            case 3: return 'col-md-4';
            case 4: return 'col-md-3';
            case 5: return 'col-md-custom-5';
            case 6: return 'col-md-2';
            default: return 'col-md-6';
        }
    }
    
    // Function to reorganize cards based on selected columns per row
    function reorganizeCards() {
        const streamingResults = $('#streaming-results');
        // If layout already stabilized once, skip further reorganize calls to avoid any reshuffle
        if (streamingResults.data('layoutStable') === true) {
            return;
        }
        // Columns are automatically determined based on number of observables
        
        // Get all observable cards - find them correctly whether wrapped in columns or not
        // We need to find the actual card elements, not their wrappers
        const allCardElements = [];
        
        // Find all elements with observable-header, then get their parent card
        streamingResults.find('.observable-header').each(function() {
            const header = $(this);
            const card = header.closest('.card');
            if (card.length > 0 && allCardElements.indexOf(card[0]) === -1) {
                allCardElements.push(card[0]);
            }
        });
        
        if (allCardElements.length === 0) return;
        
        // Check if layout is already correct to avoid unnecessary reorganization
        const numObservables = allCardElements.length;
        const hasRows = streamingResults.find('.row').length > 0;
        const expectedColClass = getColumnClass(2); // col-md-6
        const colClassBase = expectedColClass.split(' ')[0]; // 'col-md-6'
        const currentCols = streamingResults.find(`.row .${colClassBase}`).length;
        
        // Check if cards are already wrapped in columns within rows
        const cardsInRows = streamingResults.find('.row [class*="col-"] .observable-card, .row [class*="col-"] .card').filter(function() {
            return $(this).find('.observable-header').length > 0;
        }).length;
        
        // Check if there are any cards NOT in rows (directly in streaming-results)
        const cardsNotInRows = streamingResults.find('> .card, > .observable-card').filter(function() {
            return $(this).find('.observable-header').length > 0 && $(this).closest('.row').length === 0;
        }).length;
        
        // Only skip reorganization if:
        // 1. We have rows
        // 2. All observables are already in rows with column wrappers
        // 3. No cards are directly in streaming-results (not in rows)
        // 4. The number of columns matches the number of observables
        // 5. The layout structure is already correct (rows with proper column classes)
        // If cards are already in rows/cols with no stray cards and expected col layout, avoid rebuild
        const expectedCols = streamingResults.find('.row .col-md-6, .row .col-lg-6').length;
        if (hasRows && cardsInRows === numObservables && cardsNotInRows === 0 && expectedCols === numObservables) {
            streamingResults.find('.row').each(function() {
                const row = $(this);
                const numCards = row.find('[class*="col-"]').length;
                if (numCards === 1) {
                    row.css('justify-content', 'center');
                } else {
                    row.css('justify-content', 'flex-start');
                }
            });
            applyToolCardsLayout();
            filterSafeResults();
            return;
        }
        
        // Assign persistent order to any cards missing it (based on observable/type)
        Array.from(allCardElements).forEach(function(el) {
            const card = $(el).closest('.card');
            ensureCardOrder(card);
        });

        // Keep stable order using data-order
        const cardsInOrder = Array.from(allCardElements).sort(function(a, b) {
            const orderA = parseInt($(a).attr('data-order'), 10);
            const orderB = parseInt($(b).attr('data-order'), 10);
            if (!isNaN(orderA) && !isNaN(orderB) && orderA !== orderB) {
                return orderA - orderB;
            }
            return 0;
        });
        
        // Detach cards to preserve their state and avoid recreating HTML (reduces flicker)
        const detachedCards = cardsInOrder.map(function(cardElement) {
            // If wrapped in a column, detach the card itself
            const card = $(cardElement);
            const parentCol = card.closest('[class*="col-"]');
            const targetCard = parentCol.length > 0 && parentCol.find('.card').length > 0
                ? parentCol.find('.card').first()
                : card;
            return targetCard.detach();
        });
        
        // Clear existing layout wrappers but reuse existing rows if possible
        const existingRows = streamingResults.find('.row').detach().toArray();
        streamingResults.empty();
        
        // Use 2 columns for observables (col-md-6) so they appear side by side
        const actualColumnsPerRow = 2;
        const actualColClass = getColumnClass(actualColumnsPerRow); // col-md-6
        
        // Reorganize cards into rows with 2 columns, so observables appear side by side
        let currentRow = null;
        detachedCards.forEach(function(card, index) {
            // Try to place in existing rows first if they have room
            let targetRow = $(existingRows).filter(function() {
                return $(this).find('.observable-card').length < actualColumnsPerRow;
            }).first();
            
            if (!targetRow.length) {
                // Start a new row every time existing rows are full
                targetRow = $('<div class="row" style="width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 20px; margin-top: 0;"></div>');
                streamingResults.append(targetRow);
                existingRows.push(targetRow[0]);
            } else {
                // If using an existing row, re-append it to keep order
                streamingResults.append(targetRow);
            }
            
            // Wrap card in column div (col-md-6) so 2 observables fit side by side
            const wrappedCard = $(`<div class="${actualColClass}" style="padding-left: 15px; padding-right: 15px; margin-bottom: 0;"></div>`);
            wrappedCard.append(card);
            targetRow.append(wrappedCard);
        });
        
        // Adjust justify-content based on number of observables in each row
        // Single observable: center it, multiple observables: align to start (side by side)
        streamingResults.find('.row').each(function() {
            const row = $(this);
            const numCards = row.find('[class*="col-"]').length;
            if (numCards === 1) {
                row.css('justify-content', 'center');
            } else {
                row.css('justify-content', 'flex-start');
            }
        });
        
        // Apply tool cards layout after reorganizing
        applyToolCardsLayout();

        // Mark layout as stable to prevent future reshuffles
        streamingResults.data('layoutStable', true);
    }
    
    // Function to apply column layout to tool cards within observable cards
    function applyToolCardsLayout() {
        // Most tool cards use 3 columns layout (col-md-4) to better utilize space
        const toolColClass = 'col-md-4 col-lg-3';
        
        // First, ensure all tool card rows have uniform spacing
        $('.observable-card .tool-cards-row, .observable-card .card-body .row').each(function() {
            $(this).css({
                'margin-left': '0',
                'margin-right': '0',
                'margin-top': '0',
                'margin-bottom': '0',
                'padding-left': '0',
                'padding-right': '0'
            });
        });
        
        // Ensure all tool card columns have uniform spacing
        $('.observable-card .tool-cards-row > [class*="col-"], .observable-card .card-body .row > [class*="col-"], .observable-card .tool-cards-row > .tool-card-col').each(function() {
            $(this).css({
                'margin-left': '0',
                'margin-right': '0',
                'margin-top': '0',
                'margin-bottom': '0',
                'padding-left': '0',
                'padding-right': '0'
            });
        });
        
        // URLScan cards need more space for tables and screenshots - ensure they stay wide
        $('.urlscan-box').closest('[class*="col-"]').each(function() {
            $(this).removeClass('col-md-4 col-md-6 col-lg-3 col-lg-6').addClass('col-md-6 col-lg-6');
            $(this).css({
                'margin-left': '0',
                'margin-right': '0',
                'margin-top': '0',
                'margin-bottom': '0',
                'padding-left': '0',
                'padding-right': '0'
            });
        });
        
        // Apply to all other tool cards within observable cards (skip URLScan)
        $('.observable-card .tool-cards-row .tool-card-col, .observable-card .tool-cards-row .col-md-4, .observable-card .tool-cards-row .col-md-6').each(function() {
            // Skip if it contains a URLScan box
            if ($(this).find('.urlscan-box').length > 0 || $(this).hasClass('urlscan-box')) {
                return;
            }
            // Remove any existing column classes
            $(this).removeClass('col-md-12 col-md-6 col-md-4 col-md-3 col-md-2 col-md-custom-5 col-lg-2 col-lg-3 col-lg-6 col-xl-2');
            // Add col-md-4 col-lg-3 for 3-4 columns layout
            $(this).addClass(toolColClass);
            // Ensure uniform spacing
            $(this).css({
                'margin-left': '0',
                'margin-right': '0',
                'margin-top': '0',
                'margin-bottom': '0',
                'padding-left': '0',
                'padding-right': '0'
            });
        });
        
        // Also handle tool cards that are directly in .row without .tool-card-col wrapper
        $('.observable-card .card-body .row > .col-md-12').each(function() {
            // Skip if it contains a URLScan box
            if ($(this).find('.urlscan-box').length > 0) {
                $(this).removeClass('col-md-12').addClass('col-md-6 col-lg-6');
                $(this).css({
                    'margin-left': '0',
                    'margin-right': '0',
                    'margin-top': '0',
                    'margin-bottom': '0',
                    'padding-left': '0',
                    'padding-right': '0'
                });
                return;
            }
            // Convert col-md-12 to col-md-4 col-lg-3 for 3-4 columns
            $(this).removeClass('col-md-12').addClass('col-md-4 col-lg-3');
            $(this).css({
                'margin-left': '0',
                'margin-right': '0',
                'margin-top': '0',
                'margin-bottom': '0',
                'padding-left': '0',
                'padding-right': '0'
            });
        });
    }

    $(document).ready(function() {
        // Load saved tool selections and form content on page load
        loadSavedData();
        
        // Initialize search functionality for results
        $(document).on('input', '#results-search', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.results-container .card').each(function() {
                const cardText = $(this).text().toLowerCase();
                const cardRow = $(this).closest('.row, .col-md-12, .col-md-6, .col-md-4, .col-md-3, .col-md-2, .col-md-custom-5');
                if (cardText.includes(searchTerm)) {
                    cardRow.show();
                } else {
                    cardRow.hide();
                }
            });
        });
        
        
            
        // Initialize DataTables for URLScan, CRT.sh, and OpenCTI
        $('.urlscan-box .table, .ssl-table, .opencti-box .table').each(function() {
            if ($(this).find('thead').length > 0) {
                $(this).DataTable({
                    "pageLength": 100,
                    "order": [[0, 'asc']],
                    "columnDefs": [
                        { "orderable": true, "targets": "_all" }
                    ],
                    "paging": false,
                    "info": false,
                    "searching": false,
                    "dom": 't'  // Only show the table
                });
            }
        });

        // Initialize DataTable for CRT.sh with specific sorting
        $('.ssl-table').each(function() {
            if ($(this).find('thead').length > 0) {
                $(this).DataTable({
                    "pageLength": 100,
                    "order": [[0, 'desc']],  // First column = Logged At, sort descending
                    "columnDefs": [
                        { "orderable": true, "targets": "_all" }
                    ],
                    "paging": false,
                    "searching": false,
                    "info": false,
                    "dom": 't'  // Only show the table
                });
            }
        });

        // Initialize streaming order bookkeeping based on any pre-rendered cards
        const streamingResults = $('#streaming-results');
        if (streamingResults.length) {
            const existingCards = streamingResults.find('.observable-card');
            const positions = {};
            existingCards.each(function(idx) {
                const key = getObservableKey($(this));
                positions[key] = idx;
            });
            streamingResults
                .data('nextPos', existingCards.length || 0)
                .data('positions', positions);
        }

        // Load saved tool selections and form content
        function loadSavedData() {
            const savedTools = localStorage.getItem('selectedTools');
            const savedObservables = localStorage.getItem('observables');
            
            if (savedTools) {
                const tools = JSON.parse(savedTools);
                tools.forEach(tool => {
                    $(`input[value="${tool}"]`).prop('checked', true);
                });
            }
            
            if (savedObservables) {
                $('#observables').val(savedObservables);
            }
        }

        // Function to check API status and uncheck invalid tools
        function checkApiStatus() {
            // List of tools that require API keys
            const apiTools = {
                'AbuseIPDB': 'abuseipdb',
                'IPInfo': 'ipinfo',
                'URLScanScan': 'urlscan',
                'VirusTotal': 'virustotal',
                'OpenCTI': 'opencti'
            };

            // Check each tool and uncheck/disable only if API is invalid (not unknown)
            Object.entries(apiTools).forEach(([toolName, apiKey]) => {
                const checkbox = $(`input[value="${toolName}"]`);
                const status = API_STATUS[apiKey];
                if (status === 'invalid') {
                    checkbox.prop('checked', false);
                    checkbox.prop('disabled', true);
                    checkbox.closest('.form-check').find('label').addClass('text-muted');
                } else {
                    // Valid or unknown - enable checkbox
                    checkbox.prop('disabled', false);
                    checkbox.closest('.form-check').find('label').removeClass('text-muted');
                }
            });
        }

        // Save tool selections and form content when changed
        $('input[name="tools"]').change(function() {
            const selectedTools = $('input[name="tools"]:checked').map(function() {
                return $(this).val();
            }).get();
            localStorage.setItem('selectedTools', JSON.stringify(selectedTools));
        });

        $('#observables').on('input', function() {
            localStorage.setItem('observables', $(this).val());
        });

        // Handle form submission
        $('form').submit(function(e) {
            e.preventDefault();
            
            // Check API status before submission
            checkApiStatus();
            
            // Remove any previous results or errors
            $('.results-container').remove();
            $('.alert').remove();
            $('.loading-overlay').remove();
            resetObservableStore();
            
            // Show loading spinner in the center
            $('body').append(`
                <div class="loading-overlay">
                    <div class="loading-spinner"></div>
                </div>
            `);
            
            // Get selected tools
            let selectedTools = $('input[name="tools"]:checked').map(function() {
                return $(this).val();
            }).get();
            // Drop tools whose API key is marked invalid (red)
            const apiTools = {
                'AbuseIPDB': 'abuseipdb',
                'IPInfo': 'ipinfo',
                'URLScanScan': 'urlscan',
                'VirusTotal': 'virustotal',
                'OpenCTI': 'opencti'
            };
            selectedTools = selectedTools.filter(tool => {
                const apiKeyName = apiTools[tool];
                if (!apiKeyName) return true;
                const status = API_STATUS[apiKeyName];
                if (status === 'invalid') {
                    console.warn(`Skipping ${tool} because API key status is invalid`);
                    return false;
                }
                return true;
            });
            
            // Get the observables
            const observables = $('#observables').val().trim().split('\n').filter(obs => obs.trim());
            
            // Function to resolve domain to IP
            async function resolveDomain(domain) {
                try {
                    const response = await fetch(`/resolve_domain?domain=${encodeURIComponent(domain)}`);
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    console.error('Error resolving domain:', error);
                    return null;
                }
            }
            
            // Get processing options from localStorage
            // Default to true if not set (enable auto-resolve by default)
            const processingOptions = JSON.parse(localStorage.getItem('processingOptions') || '{}');
            const autoResolveDomain = processingOptions.auto_resolve_domain !== undefined ? processingOptions.auto_resolve_domain : true;
            const autoResolveUrl = processingOptions.auto_resolve_url !== undefined ? processingOptions.auto_resolve_url : true;
            const autoResolveUrlIp = processingOptions.auto_resolve_url_ip !== undefined ? processingOptions.auto_resolve_url_ip : true;
            
            console.log('Processing options:', { autoResolveDomain, autoResolveUrl, processingOptions });
            
            // Process each observable (async wrapper)
            (async function() {
                const processedObservables = [];
                await Promise.all(observables.map(async (observable) => {
                // Check if it's a domain (simple check for now)
                const isDomain = observable.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/);
                
                // When auto_resolve_domain is enabled, don't add the IP here
                // The backend will handle domain resolution and IP processing automatically
                // Just add the domain as-is
                processedObservables.push(observable);
                }));
                
                // Use processed observables (just the original observables, backend will handle IP resolution)
                const finalObservables = processedObservables.length > 0 ? processedObservables : observables;
                // Don't update the textarea with resolved IPs (keep original input)
                
                // Create results container with cardView and streaming-results
                $('form').after(`
                    <div class="results-container">
                        <div class="d-flex align-items-center mt-3">
                            <h2 class="mb-0 d-flex align-items-center">
                                Results
                                <span id="results-timestamp" class="badge badge-light ml-2" style="display:none; font-size: 0.8rem;"></span>
                                <span id="results-status" class="alert alert-info py-1 px-2 mb-0 ml-2" style="font-size: 0.85rem; display: none;">
                                    <span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>
                                </span>
                            </h2>
                        </div>
                        <div id="cardView" class="mt-3">
                            <div id="streaming-results">
                            </div>
                        </div>
                    </div>
                `);
        // Reset streaming order bookkeeping
        $('#streaming-results').data('nextPos', 0).data('positions', {});
                
                // Create form data with all observables
                const formData = new FormData();
                formData.append('observables', finalObservables.join('\n'));
                selectedTools.forEach(tool => {
                    formData.append('tools', tool);
                });
                // Add processing options
                formData.append('auto_resolve_domain', autoResolveDomain ? 'true' : 'false');
                formData.append('auto_resolve_url', autoResolveUrl ? 'true' : 'false');
                formData.append('auto_resolve_url_ip', autoResolveUrlIp ? 'true' : 'false');
                
                // Submit the form via AJAX to start processing
                $.ajax({
                    url: window.location.pathname,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // Restore checkbox states from localStorage after AJAX call
                        const savedTools = localStorage.getItem('selectedTools');
                        if (savedTools) {
                            const tools = JSON.parse(savedTools);
                            tools.forEach(tool => {
                                $(`input[value="${tool}"]`).prop('checked', true);
                            });
                        }
                        
                        // Parse response to get processing_id
                        const tempDiv = $('<div>').html(response);
                        const processingId = tempDiv.find('[data-processing-id]').attr('data-processing-id') || 
                                           tempDiv.find('script').text().match(/processing_id['"]:\s*['"]([^'"]+)['"]/)?.[1];
                        
                        if (!processingId) {
                            // Remove loading overlay if no processing_id (fallback)
                            $('.loading-overlay').remove();
                            // Fallback to normal rendering if no processing_id
                        $('.results-container').remove();
                        $('.alert').remove();
                        if (tempDiv.find('.results-container').length) {
                            $('form').after(tempDiv.find('.results-container'));
                            }
                            // Restore checkboxes again after rendering
                            if (savedTools) {
                                const tools = JSON.parse(savedTools);
                                tools.forEach(tool => {
                                    $(`input[value="${tool}"]`).prop('checked', true);
                                });
                            }
                            return;
                        }
                        
                        // Results container should already exist with loading cards
                        // Just ensure streaming-results exists and has loading cards
                        if ($('.results-container').length) {
                            const container = $('.results-container');
                            // Ensure cardView is visible
                            const cardView = container.find('#cardView');
                            if (cardView.length) {
                                cardView.show();
                            }
                            // Ensure streaming-results exists
                            const streamingResults = container.find('#streaming-results');
                            if (!streamingResults.length) {
                                if (!cardView.length) {
                                    container.append(`
                                        <div id="cardView" class="mt-4">
                                            <div id="streaming-results"></div>
                                        </div>
                                    `);
                                } else {
                                    cardView.append(`<div id="streaming-results"></div>`);
                                }
                            }
                        }
                        
                        // Ensure cardView is visible
                        const cardView = $('.results-container #cardView');
                        if (cardView.length) {
                            cardView.show();
                        }
                        
                        // Show loading indicator
                        $('#results-status').show().removeClass('alert-success alert-danger').addClass('alert-info').html(`
                            <span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>
                        `);
                        
                        // Connect to SSE stream
                        const eventSource = new EventSource(`/api/stream_results/${processingId}`);
                        
                        eventSource.onmessage = function(event) {
                            try {
                                const data = JSON.parse(event.data);
                                console.log('SSE message received:', data);
                                
                                // Update loading indicator state
                                if (data.completed || data.final) {
                                    $('#results-status').removeClass('alert-info alert-danger').addClass('alert-success').html('<i class="fas fa-check-circle"></i>');
                                    // Hide after short delay
                                    setTimeout(() => $('#results-status').fadeOut(300), 1200);
                                } else {
                                    $('#results-status').show();
                                }
                                
                                // Restore checkboxes on every SSE message
                                const savedTools = localStorage.getItem('selectedTools');
                                if (savedTools) {
                                    const tools = JSON.parse(savedTools);
                                    tools.forEach(tool => {
                                        $(`input[value="${tool}"]`).prop('checked', true);
                                    });
                                }
                                
                                if (data.error) {
                                    $('#streaming-results').html(`<div class="alert alert-danger">${data.error}</div>`);
                                    eventSource.close();
                                    return;
                                }
                                
                                if (data.results && data.results.length > 0) {
                                    console.log('Updating results display with', data.results.length, 'results');
                                    // Update API status based on successful results
                                    updateApiStatusFromResults(data.results);
                                    // Update timestamp badge
                                    updateTimestampBadge(data.results);
                                    // Remove loading overlay when first results arrive
                                    $('.loading-overlay').remove();
                                    // Remove any "Starting investigation" message
                                    $('#streaming-results .alert-info').remove();
                                    // Update results display immediately without blocking
                                    updateResultsDisplay(data.results, selectedTools);
                                }
                                
                                if (data.completed || data.final) {
                                    console.log('Processing completed');
                                    // Remove loading overlay when processing is complete
                                    $('.loading-overlay').remove();
                                    eventSource.close();
                                    
                                    // Check if we already have observable cards displayed
                                    const existingCards = $('#streaming-results .card').filter(function() {
                                        return $(this).find('.observable-header').length > 0;
                                    });
                                    
                                    console.log('Existing observable cards count:', existingCards.length);
                                    
                                    // Only perform final update if we don't have cards yet
                                    if (existingCards.length === 0) {
                                        console.log('No existing cards, performing final update');
                                        if (data.results && data.results.length > 0) {
                                            // Update API status based on successful results
                                            updateApiStatusFromResults(data.results);
                                            // Update timestamp badge
                                            updateTimestampBadge(data.results);
                                            $('#streaming-results .alert-info').remove();
                                            updateResultsDisplay(data.results, selectedTools);
                                        } else {
                                            $('#streaming-results').html('<div class="alert alert-warning">No results found.</div>');
                                        }
                                    } else {
                                        console.log('Cards already displayed (' + existingCards.length + ' cards), skipping final update to prevent overwrite');
                                        // Still update timestamp even if cards exist
                                        if (data.results && data.results.length > 0) {
                                            updateTimestampBadge(data.results);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing SSE message:', e, event.data);
                            }
                        };
                        
                        eventSource.onerror = function(event) {
                            console.error('SSE error:', event);
                            eventSource.close();
                            $('.loading-overlay').remove();
                            $('#results-status').removeClass('alert-info alert-success').addClass('alert-danger').html('');
                            $('#results-status').show();
                            $('#streaming-results').html('<div class="alert alert-warning">Connection lost. Results may be incomplete.</div>');
                        };
                    },
                    error: function(xhr, status, error) {
                        // Restore checkbox states from localStorage on error
                        const savedTools = localStorage.getItem('selectedTools');
                        if (savedTools) {
                            const tools = JSON.parse(savedTools);
                            tools.forEach(tool => {
                                $(`input[value="${tool}"]`).prop('checked', true);
                            });
                        }
                        
                        $('.results-container').remove();
                        $('.alert').remove();
                        $('form').after('<div class="alert alert-danger mt-3">An error occurred while processing your request. Please try again.</div>');
                    }
                });
            })();
        });

        // Handle reset button click
        $('#resetButton').click(function() {
            // Clear textarea
            $('#observables').val('');
            
            // Uncheck all checkboxes
            $('input[type="checkbox"]').prop('checked', false);
            
            // Clear saved data
            localStorage.removeItem('selectedTools');
            localStorage.removeItem('observables');
            
            // Clear any results
            $('.results-container').remove();
            
            // Clear any error messages
            $('.alert').remove();
        });

        // Load saved data and check API status on page load
        loadSavedData();
        checkApiStatus();
        
        // Also restore checkboxes after any DOM updates (in case AJAX response modified them)
        $(document).ajaxComplete(function(event, xhr, settings) {
            // Only restore for our AJAX calls, not for render_results
            if (settings.url && !settings.url.includes('/api/render_results')) {
                const savedTools = localStorage.getItem('selectedTools');
                if (savedTools) {
                    const tools = JSON.parse(savedTools);
                    tools.forEach(tool => {
                        $(`input[value="${tool}"]`).prop('checked', true);
                    });
                }
            }
        });
        
        // Initialize DataTables for URLScan, CRT.sh, and OpenCTI
        $('.urlscan-box .table, .ssl-table, .opencti-box .table').each(function() {
            if ($(this).find('thead').length > 0) {
                $(this).DataTable({
                    "pageLength": 100,
                    "order": [[0, 'asc']],
                    "columnDefs": [
                        { "orderable": true, "targets": "_all" }
                    ],
                    "paging": false,
                    "info": false,
                    "searching": false,
                    "dom": 't'  // Only show the table
                });
            }
        });

        // Initialize DataTable for CRT.sh with specific sorting
        $('.ssl-table').each(function() {
            if ($(this).find('thead').length > 0) {
                $(this).DataTable({
                    "pageLength": 100,
                    "order": [[0, 'desc']],  // First column = Logged At, sort descending
                    "columnDefs": [
                        { "orderable": true, "targets": "_all" }
                    ],
                    "paging": false,
                    "searching": false,
                    "info": false,
                    "dom": 't'  // Only show the table
                });
            }
        });

        // Show/hide URLScan options when URLScan is selected
        document.getElementById('urlscan_scan').addEventListener('change', function() {
            const urlscanOptions = this.parentElement.querySelector('.urlscan-options');
            urlscanOptions.style.display = this.checked ? 'block' : 'none';
        });

        // Disable scan options if no API key is available
        document.addEventListener('DOMContentLoaded', function() {
            const urlscanAction = document.querySelector('select[name="urlscan_scan_type"]');
            const urlscanCheckbox = document.getElementById('urlscan_scan');
            
            if (API_STATUS.urlscan === 'invalid') {
                const scanOptions = urlscanAction.querySelectorAll('option[value="public"], option[value="private"]');
                scanOptions.forEach(function(option) {
                    option.disabled = true;
                    option.title = 'API key required for scanning';
                });
            }
        });

        // Remove the old screenshot modal click handler since we're using hover now
        $('.screenshot-preview').off('click');
        
        // Add hover positioning for the preview image
        $('.screenshot-preview').hover(function() {
            const preview = $(this).find('.preview-image');
            preview.css({
                'display': 'block',
                'z-index': 9999
            });
        }, function() {
            const preview = $(this).find('.preview-image');
            preview.css('display', 'none');
        });

        function updateLoadingState(tool, isLoading) {
            const toolElement = document.getElementById(tool.toLowerCase());
            if (toolElement) {
                const icon = toolElement.querySelector('i');
                if (isLoading) {
                    icon.classList.remove('fa-server');
                    icon.classList.add('fa-spinner', 'fa-spin');
                } else {
                    icon.classList.remove('fa-spinner', 'fa-spin');
                    icon.classList.add('fa-server');
                }
            }
        }

        const selectedTools = $('input[name="tools"]:checked').map(function() {
            return $(this).val();
        }).get();

        // Initialize Wayback Machine tables
        $('table[id^="waybackTable_"]').DataTable({
            "pageLength": 10,
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "order": [[0, "desc"]],
            "language": {
                "search": "Filter snapshots:"
            }
        });

        // Save results function (CSV or JSON only) using server-side session data
        // Expose on window so inline onclick handlers can call it
        window.saveResults = function(format) {
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    format: format
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Save failed with status ' + response.status);
                }
                return response.blob();
            })
            .then(function(data) {
                const mimeType = 'application/json';
                const blob = new Blob([data], { type: mimeType });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const now = new Date();
                    const timestamp = now.toISOString()
                        .replace(/[-:]/g, '')
                        .replace('T', '_')
                        .replace('Z', '')
                        .replace('.', '_'); // YYYYMMDD_HHMMSS_mmm
                    a.download = 'investigation_results_' + timestamp + '.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('An error occurred while saving the results.');
            });
        };

        // Load results button wiring (JSON only)
        const loadBtn = document.getElementById('loadResultsBtn');
        const loadFileInput = document.getElementById('loadResultsFile');
        if (loadBtn && loadFileInput) {
            loadBtn.addEventListener('click', function() {
                loadFileInput.value = '';
                loadFileInput.click();
            });
            loadFileInput.addEventListener('change', function() {
                if (!loadFileInput.files || loadFileInput.files.length === 0) {
                    return;
                }
                const file = loadFileInput.files[0];
                const name = file.name.toLowerCase();
                const reader = new FileReader();

                reader.onerror = function() {
                    alert('Failed to read file. Please try again.');
                };

                reader.onload = function(e) {
                    const text = e.target.result;
                    if (name.endsWith('.json')) {
                        try {
                            const parsed = JSON.parse(text);
                            if (!Array.isArray(parsed)) {
                                throw new Error('JSON must be an array of results');
                            }
                            // Ensure a timestamp is present when loading from disk (NL locale, no ms)
                            const stamp = new Date().toLocaleString('nl-NL', { hour12: false });
                            parsed.forEach(r => {
                                if (r && typeof r === 'object' && !r.saved_at) {
                                    r.saved_at = stamp;
                                }
                            });
                            // Render immediately using existing pipeline
                            updateResultsDisplay(parsed, [], '');
                        } catch (err) {
                            console.error(err);
                            alert('Invalid JSON file: ' + err.message);
                        }
                    } else {
                        alert('Unsupported file type. Please select a .json file.');
                    }
                };

                reader.readAsText(file);
            });
        }
    });

        // Function to check if a card should be hidden based on hide_safe_results setting
        function shouldHideCard(cardElement) {
            const processingOptions = JSON.parse(localStorage.getItem('processingOptions') || '{}');
            const hideSafeResults = processingOptions.hide_safe_results === true;
            
            if (!hideSafeResults) {
                return false; // Don't hide if setting is disabled
            }

            // Explicit handling for VirusTotal: only hide when detections are zero
            const toolName = cardElement.attr('data-tool');
            if (toolName === 'virustotal') {
                // Try risk score first
                const riskText = cardElement.find('.risk-score').text() || '';
                const riskMatch = riskText.match(/(\d+)/);
                if (riskMatch && parseInt(riskMatch[1], 10) > 0) {
                    return false;
                }
                // Check malicious engines count
                const maliciousText = cardElement.text().match(/Malicious Engines:\s*(\d+)/i);
                if (maliciousText && parseInt(maliciousText[1], 10) > 0) {
                    return false;
                }
                // Check detection ratio
                const ratioMatch = cardElement.text().match(/Detection Ratio:\s*(\d+)\s*\/\s*(\d+)/i);
                if (ratioMatch) {
                    const numerator = parseInt(ratioMatch[1], 10);
                    const denominator = parseInt(ratioMatch[2], 10);
                    if (denominator > 0 && numerator > 0) {
                        return false;
                    }
                }
                // If we got here, treat as safe (hide)
                return true;
            }
            
            // Universal check: look for data-is-safe attribute (preferred method)
            const dataIsSafe = cardElement.attr('data-is-safe');
            if (dataIsSafe !== undefined) {
                return dataIsSafe === 'true';
            }
            
            // Fallback: Check for "Safe", "Not Found", "Not in Database" status badges
            // (for backwards compatibility with cards that don't have data-is-safe yet)
            const cardText = cardElement.text().toLowerCase();
            const statusBadges = cardElement.find('.badge');
            const cardBody = cardElement.find('.card-body');
            const bodyText = cardBody.text().toLowerCase();
            
            // Check for "No data returned or invalid format" in card text
            if (cardText.includes('no data returned or invalid format') ||
                cardText.includes('no data returned') ||
                cardText.includes('invalid format')) {
                return true;
            }
            // Check alerts for the same phrase
            const alertText = cardElement.find('.alert').text().toLowerCase();
            if (alertText.includes('no data returned or invalid format') ||
                alertText.includes('no data returned') ||
                alertText.includes('invalid format')) {
                return true;
            }
            
            // Check badge text for safe/not found statuses
            let hasSafeStatus = false;
            statusBadges.each(function() {
                const badgeText = $(this).text().toLowerCase();
                if (badgeText.includes('safe') || 
                    badgeText.includes('not found') || 
                    badgeText.includes('not in database') ||
                    badgeText.includes('not in blacklist') ||
                    badgeText.includes('not found in threat feeds')) {
                    hasSafeStatus = true;
                    return false; // Break loop
                }
            });
            
            // Check for URLQuery cards with 0 results
            if (!hasSafeStatus) {
                const cardHeader = cardElement.find('.card-header h6, .card-header h5').first().text().trim();
                if (cardHeader.includes('URLQuery')) {
                    // Check if header shows "0 report" or "0 reports"
                    if (cardHeader.includes('(0 report')) {
                        hasSafeStatus = true;
                    }
                    // Check message for "Found 0 report" or "Found 0 reports"
                    else if (bodyText.includes('found 0 report')) {
                        hasSafeStatus = true;
                    }
                    // Also check message for "No reports found in URLQuery database"
                    else if (bodyText.includes('no reports found in urlquery database')) {
                        hasSafeStatus = true;
                    }
                }
            }
            
            // Check card body text for various safe/empty status messages
            if (!hasSafeStatus) {
                // Check for "not found in" messages
                if (bodyText.includes('not found in') && 
                    (bodyText.includes('database') || bodyText.includes('threat feeds') || bodyText.includes('blacklist'))) {
                    hasSafeStatus = true;
                }
                // Check for "no results found"
                else if (bodyText.includes('no results found')) {
                    hasSafeStatus = true;
                }
                // Check for "no certificates found"
                else if (bodyText.includes('no certificates found')) {
                    hasSafeStatus = true;
                }
                // Check for "no dns records found"
                else if (bodyText.includes('no dns records found')) {
                    hasSafeStatus = true;
                }
                // Check for "risk score: 0%" or "risk score 0%"
                else if (bodyText.includes('risk score') && bodyText.includes('0%')) {
                    hasSafeStatus = true;
                }
                // Check for "hostname: empty" or "hostname empty" or "hostname:" with nothing after (reverse DNS)
                else if (bodyText.includes('hostname')) {
                    // Check if hostname is empty - look for "hostname:" followed by only whitespace or nothing
                    const hostnamePattern = /hostname:\s*$/;
                    if (hostnamePattern.test(bodyText) || bodyText.includes('hostname: empty') || bodyText.includes('hostname empty')) {
                        hasSafeStatus = true;
                    }
                    // Also check the actual DOM element for empty hostname value
                    const hostnameElement = cardElement.find('small:contains("Hostname:")');
                    if (hostnameElement.length > 0) {
                        const hostnameText = hostnameElement.text().toLowerCase();
                        // Check if hostname is empty (just "hostname: " with nothing after)
                        if (hostnameText === 'hostname:' || hostnameText === 'hostname: ' || hostnameText.trim() === 'hostname:') {
                            hasSafeStatus = true;
                        }
                    }
                }
                // Check for "no data" messages
                else if (bodyText.includes('no data') || bodyText.includes('no information available') || 
                         bodyText.includes('data not available') || bodyText.includes('no data available') ||
                         bodyText.includes('no data returned') || bodyText.includes('invalid format') ||
                         bodyText.includes('no data returned or invalid format') ||
                         bodyText.includes('no data received from sans')) {
                    hasSafeStatus = true;
                }
                // Check for cards with only error messages (no actual data)
                else if (cardBody.find('.alert-warning, .alert-danger').length > 0) {
                    // If card only contains error alerts and no other meaningful content, hide it
                    const errorAlerts = cardBody.find('.alert-warning, .alert-danger');
                    const hasOtherContent = cardBody.find('table, ul, p:not(:has(.alert))').length > 0;
                    if (!hasOtherContent && errorAlerts.length > 0) {
                        // Check if error is about missing data or API issues
                        const errorText = errorAlerts.text().toLowerCase();
                        if (errorText.includes('no data') || errorText.includes('not available') || 
                            errorText.includes('error retrieving') || errorText.includes('failed to') ||
                            errorText.includes('no data returned') || errorText.includes('invalid format') ||
                            errorText.includes('no data returned or invalid format') ||
                            errorText.includes('no data received from sans')) {
                            hasSafeStatus = true;
                        }
                    }
                }
                // Check for empty card bodies (no meaningful content)
                else if (bodyText.trim().length < 20 && !cardBody.find('table, ul, a.btn').length) {
                    hasSafeStatus = true;
                }
            }
            
            return hasSafeStatus;
        }
        
        // Function to filter and hide safe/not found cards
        function filterSafeResults() {
            const processingOptions = JSON.parse(localStorage.getItem('processingOptions') || '{}');
            const hideSafeResults = processingOptions.hide_safe_results === true;
            
            if (!hideSafeResults) {
                // Show all cards and their parent containers if setting is disabled
                $('#streaming-results .card').show();
                $('#streaming-results .tool-card-col, #streaming-results [class*="col-"]').show();
                return;
            }
            
            // First pass: hide individual cards (do not auto-show previously hidden to avoid flicker)
            $('#streaming-results .card').each(function() {
                const card = $(this);
                // Only check tool cards, not observable header cards
                if (card.find('.observable-header').length === 0) {
                    if (shouldHideCard(card)) {
                        card.hide();
                    }
                }
            });
            
            // Second pass: hide/show parent column containers based on whether they contain any visible cards
            $('#streaming-results .tool-card-col, #streaming-results .observable-card .row > [class*="col-"]').each(function() {
                const parentCol = $(this);
                // Skip if this is an observable header container
                if (parentCol.find('.observable-header').length > 0) {
                    return;
                }
                
                // Check if this container has any visible tool cards
                const visibleCards = parentCol.find('.card').not(':hidden');
                const toolCards = parentCol.find('.card').filter(function() {
                    return $(this).find('.observable-header').length === 0;
                });
                
                // If there are tool cards but none are visible, hide the container
                if (toolCards.length > 0 && visibleCards.length === 0) {
                    parentCol.hide();
                } else if (visibleCards.length > 0) {
                    // Show the container if it has visible cards
                    parentCol.show();
                }
            });
        }
        
        // Function to update results display dynamically with streaming results
        // Function to update API status based on successful results
        function updateApiStatusFromResults(results) {
            if (!results || !Array.isArray(results)) {
                return;
            }
            
            // Mapping from data_key to api_key_name
            const dataKeyToApiKey = {
                'abuseipdb': 'abuseipdb',
                'ipinfo': 'ipinfo',
                'urlscan': 'urlscan',
                'virustotal': 'virustotal',
                'opencti': 'opencti',
                'alienvault_otx': 'alienvault_otx',
                'googlesafebrowsing': 'googlesafebrowsing',
                'urlquery': 'urlquery',
                'malwarebazaar': 'malwarebazaar',
                'threatfox': 'malwarebazaar', // Uses same key as MalwareBazaar
                'hybridanalysis': 'hybridanalysis',
                'greynoise': 'greynoise',
                'shodan': 'shodan',
                'urlhaus': 'malwarebazaar' // Uses same key as MalwareBazaar
            };
            
            let statusUpdated = false;
            const newStatus = Object.assign({}, API_STATUS);
            
            // Helper to detect auth/key errors
            function isAuthError(val) {
                if (!val) return false;
                const t = (val || '').toString().toLowerCase();
                return t.includes('api key') || t.includes('apikey') || t.includes('auth') ||
                       t.includes('unauthorized') || t.includes('forbidden') ||
                       t.includes('401') || t.includes('403') || t.includes('429');
            }
            
            // Loop through all results
            for (const result of results) {
                if (!result || !result.data) {
                    continue;
                }
                
                // Check each data key in the result
                for (const dataKey in result.data) {
                    const moduleData = result.data[dataKey];
                    
                    // Get the API key name for this data key
                    const apiKeyName = dataKeyToApiKey[dataKey];
                    if (!apiKeyName) continue;

                    // If module returned an error, mark invalid (red)
                    if (!moduleData || moduleData.error) {
                        const errText = moduleData && moduleData.error ? moduleData.error : '';
                        // Only mark invalid if it looks like an auth/key error; otherwise leave unchanged
                        if (isAuthError(errText)) {
                            if (newStatus[apiKeyName] !== 'invalid') {
                                newStatus[apiKeyName] = 'invalid';
                                statusUpdated = true;
                                console.log(`API key ${apiKeyName} marked as invalid based on ${dataKey} auth error`);
                            }
                        }
                        continue;
                    }
                    
                    // Only update to valid if we got actual data (not just an error message)
                    if (newStatus[apiKeyName] !== 'valid') {
                        const hasData = Object.keys(moduleData).some(key => 
                            key !== 'error' && 
                            key !== 'status' && 
                            moduleData[key] !== null && 
                            moduleData[key] !== undefined
                        );
                        
                        if (hasData) {
                            newStatus[apiKeyName] = 'valid';
                            statusUpdated = true;
                            console.log(`API key ${apiKeyName} marked as valid based on ${dataKey} results`);
                        }
                    }
                }
            }
            
            // Update UI if status changed
            if (statusUpdated) {
                updateApiStatusInUI(newStatus);
            }
        }
        
        function updateTimestampBadge(results) {
            const tsBadge = document.getElementById('results-timestamp');
            if (!tsBadge) return;
            const hasResults = Array.isArray(results) && results.length > 0;
            if (!hasResults) {
                tsBadge.style.display = 'none';
                return;
            }
            // Prefer saved_at from data; fallback to now
            const rawTs = results.find(r => r && r.saved_at)?.saved_at ||
                       new Date().toISOString();
            let tsText = rawTs;
            const parsed = Date.parse(rawTs);
            if (!Number.isNaN(parsed)) {
                const dt = new Date(parsed);
                tsText = dt.toLocaleString('nl-NL', { hour12: false });
            }
            tsBadge.textContent = tsText;
            tsBadge.style.display = 'inline-block';
        }

        function updateResultsDisplay(results, selectedTools) {
            // Show saved timestamp
            updateTimestampBadge(results);
            // Update API status based on successful results
            updateApiStatusFromResults(results);
            // Ensure cardView is visible
            const cardView = $('#cardView');
            if (cardView.length) {
                cardView.show();
            }
            
            // Ensure streaming-results exists
            if (!$('#streaming-results').length) {
                if (cardView.length) {
                    cardView.append('<div id="streaming-results"></div>');
                } else {
                    $('.results-container').append('<div id="cardView" class="mt-4"><div id="streaming-results"></div></div>');
                }
            }
            
            // Remove any "Starting investigation" message when we have results
            $('#streaming-results .alert-info').remove();
            
            if (!results || results.length === 0) {
                console.log('No results to display');
                // Check if we already have observable cards displayed
                const existingCards = $('#streaming-results .card').filter(function() {
                    return $(this).find('.observable-header').length > 0;
                });
                
                // Only show "No results found" if we don't have any cards
                if (existingCards.length === 0 && $('#streaming-results').children().length === 0) {
                    $('#streaming-results').html('<div class="alert alert-warning">No results found.</div>');
                } else if (existingCards.length > 0) {
                    console.log('Existing cards found (' + existingCards.length + '), not showing "No results found" message');
                }
                return;
            }
            
            console.log('updateResultsDisplay called with', results.length, 'results');
            console.log('Results data:', JSON.stringify(results, null, 2).substring(0, 500));
            
            // Ensure results container exists
            if ($('.results-container').length === 0) {
                $('form').after('<div class="results-container"><h2 class="mt-4">Results</h2><div id="cardView" class="mt-4"><div id="streaming-results"></div></div></div>');
            }
            
            // Ensure streaming-results exists
            if ($('#streaming-results').length === 0) {
                if ($('#cardView').length) {
                    $('#cardView').append('<div id="streaming-results"></div>');
                } else {
                    $('.results-container').append('<div id="cardView" class="mt-4"><div id="streaming-results"></div></div>');
                }
            }
            
            // Maintain canonical observable order
            window.observableOrder = window.observableOrder || [];
            results.forEach(r => {
                const key = `${(r.observable || '').trim()}::${(r.type || '').trim()}`;
                if (key && !window.observableOrder.includes(key)) {
                    window.observableOrder.push(key);
                }
            });

            // Check if observables exist AND if there's new tool data to add
            const processingOptions = JSON.parse(localStorage.getItem('processingOptions') || '{}');
            const hideSafeResults = processingOptions.hide_safe_results === true;
            const existingObservables = $('#streaming-results .observable-header').map(function() {
                return $(this).text().trim();
            }).get();
            const incomingObservables = results.map(r => (r.observable || '').trim());
            const allExist = incomingObservables.length > 0 &&
                             incomingObservables.every(o => existingObservables.includes(o));
            
            // If all observables exist, check if there's new tool data
            if (allExist) {
                let hasNewToolData = false;
                results.forEach(result => {
                    const observableText = (result.observable || '').trim();
                    const observableType = (result.type || '').trim();
                    
                    // Find existing card by observable header text and type
                    const existingCard = $('#streaming-results .card').filter(function() {
                        const headerText = $(this).find('.observable-header').first().text().trim();
                        const typeText = $(this).find('.observable-type').first().text().trim();
                        return headerText === observableText && typeText === observableType;
                    });
                    
                    if (existingCard.length > 0) {
                        // Check if any new tools are present in result.data that aren't already displayed
                        const existingTools = existingCard.find('[data-tool]').map(function() {
                            return $(this).attr('data-tool');
                        }).get();
                        let incomingTools = Object.keys(result.data || {});
                        // If hide-safe is enabled, ignore tools that return only benign "no data" errors
                        if (hideSafeResults) {
                            incomingTools = incomingTools.filter(tool => {
                                const d = result.data[tool];
                                if (!d || typeof d !== 'object') return true;
                                const err = (d.error || '').toString();
                                // Skip SANS "no data" noise
                                if (/no data received from sans/i.test(err)) return false;
                                // Skip generic "No data returned or invalid format" (e.g., URLHaus)
                                if (/no data returned or invalid format/i.test(err)) return false;
                                // If the object only has error + observable (no data), skip
                                const keys = Object.keys(d);
                                const hasOnlyError =
                                    (keys.length === 1 && keys[0] === 'error') ||
                                    (keys.length === 2 && keys.includes('error') && keys.includes('observable'));
                                if (hasOnlyError) return false;
                                return true;
                            });
                        }
                        
                        // Map data keys to tool names (data keys match data-tool attributes)
                        const toolKeyMap = {
                            'alienvault_otx': 'alienvault_otx',
                            'alienvault_iprep': 'alienvault_iprep',
                            'googlesafebrowsing': 'googlesafebrowsing',
                            'threatfox': 'threatfox',
                            'dns_records': 'dns_records',
                            'hybridanalysis': 'hybridanalysis',
                            'domainblocklists': 'domainblocklists',
                            'ipblocklists': 'ipblocklists',
                            'abuseipdb': 'abuseipdb',
                            'virustotal': 'virustotal',
                            'urlhaus': 'urlhaus',
                            'malwarebazaar': 'malwarebazaar',
                            'opencti': 'opencti',
                            'shodan_internetdb': 'shodan_internetdb',
                            'reversedns': 'reversedns',
                            'rdap': 'rdap'
                        };
                        
                        // Check if any incoming tool is not already displayed
                        hasNewToolData = incomingTools.some(tool => {
                            // Skip error-only data (no actual tool card should be shown)
                            if (result.data[tool] && result.data[tool].error && Object.keys(result.data[tool]).length === 2) {
                                return false; // Only has error and observable, no real data
                            }
                            const toolName = toolKeyMap[tool] || tool.toLowerCase().replace(/\s+/g, '_');
                            return !existingTools.includes(toolName);
                        });
                        
                        if (hasNewToolData) {
                            console.log(`New tool data detected for ${observableText}:`, incomingTools.filter(t => {
                                const toolName = toolKeyMap[t] || t.toLowerCase().replace(/\s+/g, '_');
                                return !existingTools.includes(toolName);
                            }));
                        }
                    } else {
                        hasNewToolData = true; // Observable card doesn't exist yet
                    }
                });
                
                if (!hasNewToolData) {
                    console.log('All observables already rendered with all tool data; skipping render_results to avoid reorder');
                    filterSafeResults();
                    return;
                } else {
                    console.log('Observables exist but new tool data detected; will update');
                }
            }

            // We will render/update; allow layout to reorganize (unset stability flag)
            const streamingResults = $('#streaming-results');
            streamingResults.data('layoutStable', false);
            
            // Use server-side rendering for proper template rendering (with timeout)
            // Avoid applying stale render responses that arrive out-of-order
            
            // Create a unique ID for this render request to track it
            const renderId = Date.now() + Math.random();
            console.log(`Starting render request ${renderId} for ${results.length} results`);
            window.latestRenderId = renderId;
            
            $.ajax({
                url: '/api/render_results',
                type: 'POST',
                contentType: 'application/json',
                timeout: 20000, // 20 second timeout
                async: true, // Ensure async
                data: JSON.stringify({
                    results: results,
                    selected_tools: selectedTools,
                }),
                success: function(responseHtml) {
                    if (window.latestRenderId && renderId !== window.latestRenderId) {
                        console.log(`Render ${renderId} is stale (latest is ${window.latestRenderId}); skipping`);
                        return;
                    }
                    console.log(`Render results received for request ${renderId}, processing...`);
                    console.log('Received HTML from render_results, length:', responseHtml.length);
                    // Mark render as fulfilled; prevent further renders after a good response to stop flicker
                    window.latestRenderId = null;
                    
                    // Restore checkboxes immediately after AJAX response
                    const savedTools = localStorage.getItem('selectedTools');
                    if (savedTools) {
                        const tools = JSON.parse(savedTools);
                        tools.forEach(tool => {
                            $(`input[value="${tool}"]`).prop('checked', true);
                        });
                    }
                    
                    // Parse the response to extract results
                    const tempDiv = $('<div>').html(responseHtml);
                    
                    // First try to find the results-container directly
                    let resultsContainer = tempDiv.find('.results-container');
                    let cardView = null;
                    
                    if (resultsContainer.length > 0) {
                        console.log('Found results-container in response');
                        cardView = resultsContainer.find('#cardView');
                    } else {
                        // Fallback: find cardView directly
                        cardView = tempDiv.find('#cardView');
                    }
                    
                    console.log('Found cardView:', cardView.length);
                    if (cardView.length) {
                        console.log('cardView HTML length:', cardView.html() ? cardView.html().length : 0);
                        console.log('Total cards in cardView:', cardView.find('.card').length);
                        const observableCards = cardView.find('.card').filter(function() {
                            return $(this).find('.observable-header').length > 0;
                        });
                        // Assign data-order based on canonical observableOrder
                        if (window.observableOrder && window.observableOrder.length) {
                            observableCards.each(function() {
                                const oc = $(this);
                                const key = getObservableKey(oc);
                                const idx = window.observableOrder.indexOf(key);
                                if (idx >= 0) {
                                    oc.attr('data-order', idx + 1);
                                }
                            });
                        }
                        console.log('Observable cards in cardView:', observableCards.length);
                        if (observableCards.length > 0) {
                            console.log('First observable card HTML preview:', observableCards.first().html().substring(0, 200));
                        }
                    }
                    
                    // If no cardView found, try finding results container directly
                    if (!cardView.length) {
                        console.log('No cardView found, trying to find .results-container');
                        const resultsContainer = tempDiv.find('.results-container');
                        if (resultsContainer.length) {
                            console.log('Found results-container, extracting cardView from it');
                            const extractedCardView = resultsContainer.find('#cardView');
                            if (extractedCardView.length) {
                                cardView = extractedCardView;
                            } else {
                                // If no cardView in results-container, use the whole results-container
                                console.log('No cardView in results-container, using results-container directly');
                                cardView = resultsContainer;
                            }
                        }
                    }
                    
                    // If still no cardView, try finding cards directly in the response
                    if (!cardView.length) {
                        console.log('Still no cardView, searching for cards with observable-header');
                        const directObservableCards = tempDiv.find('.card').filter(function() {
                            return $(this).find('.observable-header').length > 0;
                        });
                        console.log('Direct observable cards found:', directObservableCards.length);
                        if (directObservableCards.length > 0) {
                            console.log('Found', directObservableCards.length, 'observable cards directly in response');
                                // Use these cards directly
                                const streamingResults = $('#streaming-results');
                            if (streamingResults.length) {
                                // Don't empty - keep loading cards until we verify cards have data
                                directObservableCards.each(function(index) {
                                    const card = $(this);
                                    const cardHtml = card[0].outerHTML;
                                    const observableText = card.find('.observable-header').first().text().trim();
                                    
                                    // Check if card actually has data (not just headers)
                                    const hasData = card.find('.card-body').text().trim().length > 0;
                                    const hasToolContent = card.find('.tool-card-col').length > 0 || card.find('.card-body .card').length > 0;
                                    if (!hasData || !hasToolContent) {
                                        console.log(`Direct card for ${observableText} has insufficient data yet, skipping`);
                                        return; // Skip adding empty/placeholder cards to avoid flicker
                                    }
                                    
                                    // Check if this observable already exists (match by observable + type)
                                    const observableType = card.find('.observable-type').first().text().trim();
                                    const existingCard = streamingResults.find('.card').filter(function() {
                                        const existingText = $(this).find('.observable-header').first().text().trim();
                                        const existingType = $(this).find('.observable-type').first().text().trim();
                                        return existingText === observableText && existingType === observableType;
                                    });
                                    
                                    if (existingCard.length > 0) {
                                        console.log(`Updating existing direct card for: ${observableText} (${observableType})`);
                                        const newCard = $(cardHtml);
                                        const newHasData = newCard.find('.card-body').text().trim().length > 0;
                                        const newHasToolContent = newCard.find('.tool-card-col').length > 0 || newCard.find('.card-body .card').length > 0;
                                        
                                        if (!newHasData || !newHasToolContent) {
                                            console.log('New card has no data; skipping update to prevent empty flash');
                                        } else {
                                            // Instead of replacing the whole card, only add new tool cards to the end
                                            const existingToolCards = existingCard.find('.tool-card-col');
                                            const existingToolKeys = existingToolCards.map(function() {
                                                return getToolKey($(this));
                                            }).get();
                                            
                                            const newToolCards = newCard.find('.tool-card-col');
                                            const toolCardsRow = existingCard.find('.tool-cards-row').first();
                                            
                                            if (toolCardsRow.length === 0) {
                                                // No tool cards row exists, replace the whole card
                                                ensureCardOrder(existingCard);
                                                ensureCardOrder(newCard);
                                                newCard.attr('data-order', existingCard.attr('data-order'));
                                                applyToolOrder(existingCard, newCard);
                                                existingCard.replaceWith(newCard);
                                            } else {
                                                // Add only new tool cards to the end of the row
                                                let addedAny = false;
                                                newToolCards.each(function() {
                                                    const newToolCard = $(this);
                                                    const toolKey = getToolKey(newToolCard);
                                                    if (!existingToolKeys.includes(toolKey)) {
                                                        console.log(`Adding new tool card: ${toolKey} to end of observable card`);
                                                        toolCardsRow.append(newToolCard);
                                                        addedAny = true;
                                                    } else {
                                                        // Update existing tool card if content changed
                                                        const existingToolCard = existingCard.find(`.tool-card-col`).filter(function() {
                                                            return getToolKey($(this)) === toolKey;
                                                        }).first();
                                                        if (existingToolCard.length > 0) {
                                                            const existingToolHtml = existingToolCard[0].outerHTML.trim();
                                                            const newToolHtml = newToolCard[0].outerHTML.trim();
                                                            if (existingToolHtml !== newToolHtml) {
                                                                console.log(`Updating existing tool card: ${toolKey}`);
                                                                existingToolCard.replaceWith(newToolCard);
                                                                addedAny = true;
                                                            }
                                                        }
                                                    }
                                                });
                                                
                                                if (addedAny) {
                                                    applyToolCardsLayout();
                                                    filterSafeResults();
                                                }
                                            }
                                        }
                                        
                                        // Remove loading cards for tools in this card
                                        const toolCards = card.find('.card-body .row .col-md-12 .card, .card-body .row .col-md-6 .card');
                                        toolCards.each(function() {
                                            const toolCard = $(this);
                                            const toolHeader = toolCard.find('.card-header h6, .card-header h5').first().text().trim();
                                            // Use dynamic toolMappings - loading cards removed - no action needed
                                        });
                                    } else {
                                        console.log(`Adding direct observable card ${index + 1} for:`, observableText, `(${observableType})`);
                                        
                                        const tempCard = $(cardHtml);
                                        const hasData = tempCard.find('.card-body').text().trim().length > 0;
                                        const hasToolContent = tempCard.find('.tool-card-col').length > 0 || tempCard.find('.card-body .card').length > 0;
                                        if (!hasData || !hasToolContent) {
                                            console.log('New card has insufficient data; skipping append to prevent empty flash');
                                            return;
                                        }
                                        ensureCardOrder(tempCard);
                                        // Wrap in half-width column to keep grid aligned (2 per row)
                                        const colWrapper = $('<div class="col-md-6" style="padding-left: 15px; padding-right: 15px; margin-bottom: 0;"></div>');
                                        colWrapper.append(tempCard);
                                        // Place based on order into deterministic row/column
                                        const orderVal = parseInt(tempCard.attr('data-order'), 10);
                                        const rowIndex = isNaN(orderVal) ? streamingResults.find('.row').length : Math.floor((orderVal - 1) / 2);
                                        let targetRow = streamingResults.find('.row').eq(rowIndex);
                                        if (!targetRow.length) {
                                            targetRow = $('<div class="row" style="width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 20px; margin-top: 0;"></div>');
                                            // Append placeholder rows if needed
                                            const currentRows = streamingResults.find('.row').length;
                                            for (let i = currentRows; i < rowIndex; i++) {
                                                streamingResults.append('<div class="row" style="width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 20px; margin-top: 0;"></div>');
                                            }
                                            streamingResults.append(targetRow);
                                        }
                                        targetRow.append(colWrapper);
                                        reorderObservableCards();
                                        filterSafeResults();
                                    }
                                });
                                $('#cardView').show();
                                $('.results-container').show();
                                // Filter safe/not found results after displaying
                                filterSafeResults();
                                
                                // Initialize DataTables for any tables in the cards
                                setTimeout(function() {
                                    $('.results-container .table').each(function() {
                                        if ($(this).find('thead').length > 0) {
                                            if ($.fn.DataTable.isDataTable(this)) {
                                                $(this).DataTable().destroy();
                                            }
                                            $(this).DataTable({
                                                "pageLength": 100,
                                                "order": [[0, 'asc']],
                                                "columnDefs": [
                                                    { "orderable": true, "targets": "_all" }
                                                ],
                                                "paging": false,
                                                "info": false,
                                                "searching": true
                                            });
                                        }
                                    });
                                }, 100);
                                
                                return; // Exit early
                            }
                        }
                    }
                    
                    // If we still don't have cardView, try to extract from the entire response body
                    if (!cardView.length) {
                        console.log('Still no cardView, trying to extract from entire response body');
                        // Try to find the results-container div in the HTML
                        const resultsContainerStart = responseHtml.indexOf('<div class="results-container"');
                        if (resultsContainerStart !== -1) {
                            // Find the closing tag for results-container
                            let depth = 0;
                            let inTag = false;
                            let endPos = resultsContainerStart;
                            for (let i = resultsContainerStart; i < responseHtml.length; i++) {
                                if (responseHtml[i] === '<') {
                                    if (responseHtml.substring(i, i + 2) === '</') {
                                        depth--;
                                        if (depth === 0 && responseHtml.substring(i, i + 28) === '</div>') {
                                            endPos = i + 6;
                                            break;
                                        }
                                    } else if (responseHtml.substring(i, i + 5) === '<div ') {
                                        depth++;
                                    }
                                }
                            }
                            if (endPos > resultsContainerStart) {
                                const resultsHtml = responseHtml.substring(resultsContainerStart, endPos);
                                const resultsDiv = $('<div>').html(resultsHtml);
                                const extractedCards = resultsDiv.find('.card').filter(function() {
                                    return $(this).find('.observable-header').length > 0;
                                });
                                if (extractedCards.length > 0) {
                                    console.log('Found', extractedCards.length, 'cards in extracted HTML');
                                    const streamingResults = $('#streaming-results');
                                    if (streamingResults.length) {
                                        streamingResults.empty();
                                        extractedCards.each(function(index) {
                                            const cardHtml = $(this)[0].outerHTML;
                                            streamingResults.append(cardHtml);
                                        });
                                        $('#cardView').show();
                                        $('.results-container').show();
                                        
                                        // Initialize DataTables
                                        setTimeout(function() {
                                            $('.results-container .table').each(function() {
                                                if ($(this).find('thead').length > 0) {
                                                    if ($.fn.DataTable.isDataTable(this)) {
                                                        $(this).DataTable().destroy();
                                                    }
                                                    $(this).DataTable({
                                                        "pageLength": 100,
                                                        "order": [[0, 'asc']],
                                                        "columnDefs": [
                                                            { "orderable": true, "targets": "_all" }
                                                        ],
                                                        "paging": false,
                                                        "info": false,
                                                        "searching": true
                                                    });
                                                }
                                            });
                                        }, 100);
                                        
                                        return;
                                    }
                                }
                            }
                        }
                    }
                    
                    // If we still don't have cardView, log error and return
                    if (!cardView.length) {
                        console.error('ERROR: Could not find cardView or observable cards in response!');
                        console.log('Response HTML preview (first 2000 chars):', responseHtml.substring(0, 2000));
                        console.log('Searching for any .card elements:', tempDiv.find('.card').length);
                        console.log('Searching for .observable-header:', tempDiv.find('.observable-header').length);
                        return;
                    }
                    
                    // Update card view - replace content appropriately
                    if (cardView.length) {
                        // Get nested tool cards from the response
                        // The structure is: .card (observable wrapper) > .card-body > .row > .col-md-12 > .card (tool card)
                        // So we need to find cards that are inside .card-body .row
                        let toolCards = cardView.find('.card-body .row .col-md-12 .card, .card-body .row .col-md-6 .card, .card-body .row .col-md-4 .card');
                        
                        console.log('Found', toolCards.length, 'tool cards in .card-body .row');
                        
                        // If no cards found, try finding observable wrapper cards and extract their tool cards
                        if (toolCards.length === 0) {
                            console.log('No tool cards found in .card-body .row, trying observable wrapper cards');
                            const observableCards = cardView.find('.card').filter(function() {
                                return $(this).find('.observable-header').length > 0;
                            });
                            console.log('Found', observableCards.length, 'observable wrapper cards');
                            
                            observableCards.each(function() {
                                const observableCard = $(this);
                                const toolCardsInObservable = observableCard.find('.card-body .row .col-md-12 .card, .card-body .row .col-md-6 .card, .card-body .row .col-md-4 .card');
                                console.log('Found', toolCardsInObservable.length, 'tool cards in observable card');
                                toolCards = toolCards.add(toolCardsInObservable);
                            });
                        }
                        
                        // If still no cards, try direct row search
                        if (toolCards.length === 0) {
                            toolCards = cardView.find('.row .col-md-12 .card, .row .col-md-6 .card, .row .col-md-4 .card');
                            console.log('Found', toolCards.length, 'tool cards in direct .row search');
                        }
                        
                        console.log('Found', toolCards.length, 'tool cards in response');
                        console.log('Current streaming-results children:', $('#streaming-results').children().length);
                        
                        // If we have observable wrapper cards, use those instead
                        const observableCards = cardView.find('.card').filter(function() {
                            return $(this).find('.observable-header').length > 0;
                        });
                        
                        console.log('Checking for observable cards:', observableCards.length);
                        
                        if (observableCards.length > 0) {
                            console.log('Found', observableCards.length, 'observable wrapper cards, using those instead');
                            
                            // Ensure results container and cardView exist
                            if ($('.results-container').length === 0) {
                                $('form').after(`
                                    <div class="results-container">
                                        <h2 class="mt-4">Results</h2>
                                        <div class="results-controls">
                                            <div class="results-search-container">
                                                <input type="text" id="results-search" class="form-control" placeholder="Search results...">
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <label for="columns-per-row" class="mr-2">Columns per row:</label>
                                                <select id="columns-per-row" class="form-control">
                                                    <option value="1">1</option>
                                                    <option value="2" selected>2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                    <option value="6">6</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="cardView" class="mt-4">
                                            <div id="streaming-results"></div>
                                        </div>
                                    </div>
                                `);
                                
                                // Add search functionality
                                $('#results-search').on('input', function() {
                                    const searchTerm = $(this).val().toLowerCase();
                                    $('.card').each(function() {
                                        const cardText = $(this).text().toLowerCase();
                                        const cardRow = $(this).closest('.row, .col-md-12, .col-md-6, .col-md-4, .col-md-3, .col-md-2, .col-md-custom-5');
                                        if (cardText.includes(searchTerm)) {
                                            cardRow.show();
                                        } else {
                                            cardRow.hide();
                                        }
                                    });
                                });
                                
                                // Handle columns per row change
                                $('#columns-per-row').on('change', function() {
                                    reorganizeCards();
                                    applyToolCardsLayout();
            // Filter safe/not found results after applying layout
            filterSafeResults();
                                });
                            }
                            
                            // Ensure streaming-results exists
                            if ($('#streaming-results').length === 0) {
                                if ($('#cardView').length) {
                                    $('#cardView').append('<div id="streaming-results"></div>');
                                } else {
                                    $('.results-container').append('<div id="cardView" class="mt-4"><div id="streaming-results"></div></div>');
                                }
                            }
                            
                            // Get existing observable cards and their observable values
                            const existingObservableCards = $('#streaming-results .card').filter(function() {
                                return $(this).find('.observable-header').length > 0;
                            });
                            
                            const existingObservables = new Set();
                            existingObservableCards.each(function() {
                                const observableText = $(this).find('.observable-header').first().text().trim();
                                existingObservables.add(observableText);
                            });
                            
                            console.log('Existing observable cards:', existingObservableCards.length, 'Existing observables:', Array.from(existingObservables));
                            
                            // Track which tools have results in the observable cards
                            const toolsWithResults = new Set();
                            observableCards.each(function() {
                                const observableCard = $(this);
                                // Find tool cards within this observable card
                                const toolCards = observableCard.find('.card-body .row .col-md-12 .card, .card-body .row .col-md-6 .card');
                                toolCards.each(function() {
                                    const toolCard = $(this);
                                    const toolHeader = toolCard.find('.card-header h6, .card-header h5').first().text().trim();
                                    // Map tool header to data-tool key
                                    const toolKey = getToolKeyFromHeader(toolHeader);
                                    if (toolKey) {
                                        toolsWithResults.add(toolKey);
                                    }
                                });
                            });
                            
                            // Only clear if we have no existing cards
                            if (existingObservableCards.length === 0) {
                                console.log('No existing observable cards, clearing streaming-results');
                                $('#streaming-results').empty();
                            }
                            
                            // Add or update observable cards
                            observableCards.each(function(index) {
                                const originalCard = $(this);
                                // Buffer observable and its tool cards into store
                                upsertObservableCardFromHtml(originalCard);
                                existingObservables.add(originalCard.find('.observable-header').first().text().trim());
                            });
                            
                            // Render from buffered store to keep order stable
                            renderObservableStore();
                            $('#cardView').show();
                            $('.results-container').show();
                            return; // Exit early, we're done
                        }
                        
                        // Ensure results container exists and is visible
                        if ($('.results-container').length === 0) {
                            $('form').after('<div class="results-container"></div>');
                        }
                        $('.results-container').show();
                        
                        // Ensure cardView is visible
                        $('#cardView').show();
                        
                        // Update loading cards with actual data
                        toolCards.each(function() {
                            const resultCard = $(this);
                            // Find the tool name from the card header
                            let toolKey = null;
                            
                            // Get the card header text
                            const cardHeader = resultCard.find('.card-header h6, .card-header h5').first().text().trim();
                            console.log('Processing card with header:', cardHeader);
                            
                            // Map header text to tool keys using dynamic toolMappings
                            // Find matching tool key - try exact match first, then partial
                            toolKey = getToolKeyFromHeader(cardHeader);
                            if (!toolKey) {
                                for (const [header, key] of Object.entries(headerToTool)) {
                                    if (cardHeader.includes(header) || header.includes(cardHeader.split(' ')[0])) {
                                        toolKey = key;
                                        break;
                                    }
                                }
                            }
                            
                            // Also check card classes for tool indicators
                            if (!toolKey) {
                                const cardClasses = resultCard.attr('class') || '';
                                const parentClasses = resultCard.parent().attr('class') || '';
                                if (cardClasses.includes('abuseipdb') || parentClasses.includes('abuseipdb')) toolKey = 'abuseipdb';
                                else if (cardClasses.includes('ip-info-box') || cardClasses.includes('ipinfo') || parentClasses.includes('ip-info-box')) toolKey = 'ipinfo';
                                else if (cardClasses.includes('reversedns') || parentClasses.includes('reversedns')) toolKey = 'reversedns';
                                else if (cardClasses.includes('greynoise') || parentClasses.includes('greynoise')) toolKey = 'greynoise';
                                else if (cardClasses.includes('sans') || parentClasses.includes('sans')) toolKey = 'sans';
                                else if (cardClasses.includes('crtsh') || parentClasses.includes('crtsh')) toolKey = 'crtsh';
                                else if (cardClasses.includes('whois') || parentClasses.includes('whois')) toolKey = 'rdap';
                            }
                            
                            console.log('Matched tool key:', toolKey, 'for header:', cardHeader);
                            
                            if (toolKey) {
                                // Find the loading card with matching data-tool attribute in streaming-results
                                const loadingCard = $(`#streaming-results .card[data-tool="${toolKey}"]`);
                                
                                console.log(`Looking for loading card with data-tool="${toolKey}", found:`, loadingCard.length);
                                
                                if (loadingCard.length) {
                                    console.log(`Updating loading card for ${toolKey}`);
                                    // Replace the entire loading card with the result card (preserving structure)
                                    const newCard = resultCard.clone();
                                    // Preserve the data-tool attribute temporarily for tracking
                                    newCard.attr('data-tool', toolKey);
                                    // Replace the loading card
                                    loadingCard.replaceWith(newCard);
                                    // Remove data-tool after a moment to mark as updated
                                    setTimeout(() => {
                                        $(`#streaming-results .card[data-tool="${toolKey}"]`).removeAttr('data-tool');
                                    }, 100);
                                    console.log(`Successfully updated loading card for ${toolKey}`);
                                } else {
                                    console.log(`No loading card found for ${toolKey}, appending result card directly`);
                                    // No loading card found, append the card to streaming-results
                                    // Wrap in col-md-12 if not already wrapped
                                    const cardHtml = resultCard.outerHTML();
                                    if (!resultCard.parent().hasClass('col-md-12') && !resultCard.parent().hasClass('col-md-6')) {
                                        $('#streaming-results').append(`<div class="col-md-12 mb-2">${cardHtml}</div>`);
                                    } else {
                                        $('#streaming-results').append(resultCard.parent().clone());
                                    }
                                    console.log(`Appended result card for ${toolKey} to streaming-results`);
                                }
                            } else {
                                console.log('Tool key not found for header:', cardHeader, '- appending anyway');
                                // Tool key not found, append the card to streaming-results anyway
                                const cardHtml = resultCard.outerHTML();
                                if (!resultCard.parent().hasClass('col-md-12') && !resultCard.parent().hasClass('col-md-6')) {
                                    $('#streaming-results').append(`<div class="col-md-12 mb-2">${cardHtml}</div>`);
                                } else {
                                    $('#streaming-results').append(resultCard.parent().clone());
                                }
                                console.log('Appended result card without tool key');
                            }
                        });
                    } else {
                        console.log('No cardView found in response, trying alternative approach');
                        // If no cardView found, try to extract all cards directly
                        const allCards = tempDiv.find('.card');
                        console.log('Found', allCards.length, 'cards in entire response');
                        if (allCards.length > 0) {
                            // Append all cards to streaming-results
                            allCards.each(function() {
                                const card = $(this);
                                if (!card.closest('.results-container').length) {
                                    // Only append if not already in a results container
                                    $('#streaming-results').append(`<div class="col-md-12 mb-2">${card.outerHTML()}</div>`);
                                }
                            });
                        }
                    }
                    
                    // Ensure cardView is visible after update
                    $('#cardView').show();
                    $('.results-container').show();
                    
                    // Initialize DataTables for tables within cards
                    setTimeout(function() {
                        $('.results-container .table').each(function() {
                            if ($(this).find('thead').length > 0) {
                                if ($.fn.DataTable.isDataTable(this)) {
                                    $(this).DataTable().destroy();
                                }
                                $(this).DataTable({
                                    "pageLength": 100,
                                    "order": [[0, 'asc']],
                                    "columnDefs": [
                                        { "orderable": true, "targets": "_all" }
                                    ],
                                    "paging": false,
                                    "info": false,
                                    "searching": true
                                });
                            }
                        });
                    }, 100);
                },
                error: function(xhr, status, error) {
                    console.error(`Error updating results display for request ${renderId}:`, error, 'Status:', status);
                    // Don't show error if it's just a timeout or abort - results might still be updating
                    // Other render requests may still succeed
                    if (status !== 'timeout' && status !== 'abort') {
                        // Only show error if this is the first/latest render and no results are displayed
                        const hasResults = $('#streaming-results .card').filter(function() {
                            return $(this).find('.observable-header').length > 0;
                        }).length > 0;
                        if (!hasResults && $('#streaming-results').length) {
                            $('#streaming-results').html('<div class="alert alert-danger">Error loading results. Please refresh the page.</div>');
                        }
                    } else {
                        console.log(`Render results timeout/abort for request ${renderId} - other renders may still succeed`);
                    }
                }
            });
        };


    function getRiskClass(score) {
        if (score >= 80) return 'risk-high';
        if (score >= 50) return 'risk-medium';
        return 'risk-low';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function displayUrlscanResults(data) {
        const resultsDiv = document.getElementById('urlscan-results');
        if (!data || data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error fetching URLScan results'}</div>`;
            return;
        }

        let html = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        ${data.screenshot_url ? `
                            <div class="col-md-4">
                                <img src="${data.screenshot_url}" class="img-fluid" alt="Screenshot">
                            </div>
                        ` : ''}
                    </div>
                </div>
                ${data.scan_history ? `
                <h5 class="mt-3">Recent Scans</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Location</th>
                                <th>IP</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.scan_history.map(scan => `
                            <tr>
                                <td>${formatDate(scan.scan_date)}</td>
                                <td>${scan.server_location}</td>
                                <td>${scan.ip_address}</td>
                                <td>${scan.status}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                ${data.report_url ? `
                <a href="${data.report_url}" target="_blank" class="btn btn-primary mt-3">View Full Report</a>
                ` : ''}
                ${data.message ? `
                <div class="alert alert-info mt-3">${data.message}</div>
                ` : ''}
            </div>
        `;
        
        resultsDiv.innerHTML = html;
    }
</script>

</body>
</html>
